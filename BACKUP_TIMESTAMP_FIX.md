# 备份时间戳优化说明

## 问题描述

原来的备份功能使用简单的日期作为文件名，会导致同一天的多次备份相互覆盖，无法保留历史备份记录。

## 修复内容

### 1. 文件名时间戳优化

#### 数据库备份文件
- **原来**：`database-backup-2025-09-19.sql`
- **现在**：`database-backup-2025-09-19T17-30-45-123Z.sql`

#### 存储桶备份目录
- **原来**：`storage/`
- **现在**：`storage-2025-09-19T17-30-45-123Z/`

### 2. 时间戳格式

使用 ISO 8601 格式的时间戳，并替换特殊字符：
```typescript
const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T').join('_');
```

**示例时间戳**：`2025-09-19T17-30-45-123Z` → `2025-09-19_17-30-45-123Z`

### 3. 备份历史管理

#### 新增功能
- **备份历史API**：`/api/admin/backup/history`
- **历史记录显示**：在备份页面显示所有备份记录
- **文件大小统计**：显示每个备份的大小和总大小
- **时间排序**：按创建时间倒序排列

#### 历史记录信息
- 备份类型（数据库/存储桶）
- 文件名/目录名
- 文件大小
- 创建时间
- 文件路径

## 技术实现

### 时间戳生成

```typescript
// 生成唯一时间戳
const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T').join('_');

// 数据库备份文件名
const fileName = `database-backup-${timestamp}.sql`;

// 存储桶备份目录名
const storageDir = path.join(backupPath, `storage-${timestamp}`);
```

### 备份历史扫描

```typescript
// 扫描备份目录
const items = await fs.readdir(backupPath);

// 识别数据库备份文件
if (item.endsWith('.sql') && item.startsWith('database-backup-')) {
  // 处理数据库备份
}

// 识别存储桶备份目录
if (stats.isDirectory() && item.startsWith('storage-')) {
  // 处理存储桶备份
}
```

## 文件命名规则

### 数据库备份
- **格式**：`database-backup-YYYY-MM-DD_HH-MM-SS-sssZ.sql`
- **示例**：`database-backup-2025-09-19_17-30-45-123Z.sql`

### 存储桶备份
- **格式**：`storage-YYYY-MM-DD_HH-MM-SS-sssZ/`
- **示例**：`storage-2025-09-19_17-30-45-123Z/`

## 用户体验改进

### 1. 备份历史显示
- 显示所有备份记录
- 按时间倒序排列
- 显示文件大小和创建时间
- 区分数据库和存储桶备份

### 2. 文件管理
- 每次备份都有唯一的时间戳
- 不会覆盖之前的备份
- 可以保留多个历史版本

### 3. 存储空间管理
- 显示总备份大小
- 可以手动清理旧备份
- 建议定期清理策略

## 使用示例

### 备份文件结构
```
D:\backups\language-learning\
├── database-backup-2025-09-19_17-30-45-123Z.sql
├── database-backup-2025-09-19_18-15-30-456Z.sql
├── storage-2025-09-19_17-30-45-123Z\
│   ├── audio\
│   └── images\
└── storage-2025-09-19_18-15-30-456Z\
    ├── audio\
    └── images\
```

### 备份历史显示
```
备份历史
共 4 个备份，总大小: 15.2 MB

📊 database-backup-2025-09-19_18-15-30-456Z.sql
   数据库 | 5.2 MB | 2025/9/19 18:15:30

📁 storage-2025-09-19_18-15-30-456Z
   存储桶 | 10.0 MB | 2025/9/19 18:15:30

📊 database-backup-2025-09-19_17-30-45-123Z.sql
   数据库 | 5.0 MB | 2025/9/19 17:30:45

📁 storage-2025-09-19_17-30-45-123Z
   存储桶 | 9.8 MB | 2025/9/19 17:30:45
```

## 注意事项

### 1. 存储空间
- 每次备份都会创建新文件，不会覆盖
- 需要定期清理旧备份以节省空间
- 建议保留最近 7-30 天的备份

### 2. 文件管理
- 备份文件按时间戳排序
- 可以手动删除不需要的备份
- 建议制定备份保留策略

### 3. 恢复功能
- 恢复功能支持选择任意时间点的备份
- 需要确保备份文件完整且可访问

## 建议的备份策略

### 1. 自动清理
- 保留最近 7 天的完整备份
- 保留最近 30 天的每日备份
- 保留最近 12 个月的每月备份

### 2. 手动管理
- 定期检查备份历史
- 删除不需要的旧备份
- 监控存储空间使用

### 3. 备份验证
- 定期测试恢复功能
- 验证备份文件完整性
- 检查备份大小是否合理

现在每次备份都会创建带时间戳的唯一文件，不会相互覆盖，并且可以查看完整的备份历史！

