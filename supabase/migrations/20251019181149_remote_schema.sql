/*
revoke delete on table "public"."minimal_pairs" from "anon";

revoke insert on table "public"."minimal_pairs" from "anon";

revoke references on table "public"."minimal_pairs" from "anon";

revoke select on table "public"."minimal_pairs" from "anon";

revoke trigger on table "public"."minimal_pairs" from "anon";

revoke truncate on table "public"."minimal_pairs" from "anon";

revoke update on table "public"."minimal_pairs" from "anon";

revoke delete on table "public"."minimal_pairs" from "authenticated";

revoke insert on table "public"."minimal_pairs" from "authenticated";

revoke references on table "public"."minimal_pairs" from "authenticated";

revoke select on table "public"."minimal_pairs" from "authenticated";

revoke trigger on table "public"."minimal_pairs" from "authenticated";

revoke truncate on table "public"."minimal_pairs" from "authenticated";

revoke update on table "public"."minimal_pairs" from "authenticated";

revoke delete on table "public"."minimal_pairs" from "service_role";

revoke insert on table "public"."minimal_pairs" from "service_role";

revoke references on table "public"."minimal_pairs" from "service_role";

revoke select on table "public"."minimal_pairs" from "service_role";

revoke trigger on table "public"."minimal_pairs" from "service_role";

revoke truncate on table "public"."minimal_pairs" from "service_role";

revoke update on table "public"."minimal_pairs" from "service_role";

revoke delete on table "public"."pron_sentences" from "anon";

revoke insert on table "public"."pron_sentences" from "anon";

revoke references on table "public"."pron_sentences" from "anon";

revoke select on table "public"."pron_sentences" from "anon";

revoke trigger on table "public"."pron_sentences" from "anon";

revoke truncate on table "public"."pron_sentences" from "anon";

revoke update on table "public"."pron_sentences" from "anon";

revoke delete on table "public"."pron_sentences" from "authenticated";

revoke insert on table "public"."pron_sentences" from "authenticated";

revoke references on table "public"."pron_sentences" from "authenticated";

revoke select on table "public"."pron_sentences" from "authenticated";

revoke trigger on table "public"."pron_sentences" from "authenticated";

revoke truncate on table "public"."pron_sentences" from "authenticated";

revoke update on table "public"."pron_sentences" from "authenticated";

revoke delete on table "public"."pron_sentences" from "service_role";

revoke insert on table "public"."pron_sentences" from "service_role";

revoke references on table "public"."pron_sentences" from "service_role";

revoke select on table "public"."pron_sentences" from "service_role";

revoke trigger on table "public"."pron_sentences" from "service_role";

revoke truncate on table "public"."pron_sentences" from "service_role";

revoke update on table "public"."pron_sentences" from "service_role";

revoke delete on table "public"."sentence_units" from "anon";

revoke insert on table "public"."sentence_units" from "anon";

revoke references on table "public"."sentence_units" from "anon";

revoke select on table "public"."sentence_units" from "anon";

revoke trigger on table "public"."sentence_units" from "anon";

revoke truncate on table "public"."sentence_units" from "anon";

revoke update on table "public"."sentence_units" from "anon";

revoke delete on table "public"."sentence_units" from "authenticated";

revoke insert on table "public"."sentence_units" from "authenticated";

revoke references on table "public"."sentence_units" from "authenticated";

revoke select on table "public"."sentence_units" from "authenticated";

revoke trigger on table "public"."sentence_units" from "authenticated";

revoke truncate on table "public"."sentence_units" from "authenticated";

revoke update on table "public"."sentence_units" from "authenticated";

revoke delete on table "public"."sentence_units" from "service_role";

revoke insert on table "public"."sentence_units" from "service_role";

revoke references on table "public"."sentence_units" from "service_role";

revoke select on table "public"."sentence_units" from "service_role";

revoke trigger on table "public"."sentence_units" from "service_role";

revoke truncate on table "public"."sentence_units" from "service_role";

revoke update on table "public"."sentence_units" from "service_role";

revoke delete on table "public"."training_content" from "anon";

revoke insert on table "public"."training_content" from "anon";

revoke references on table "public"."training_content" from "anon";

revoke select on table "public"."training_content" from "anon";

revoke trigger on table "public"."training_content" from "anon";

revoke truncate on table "public"."training_content" from "anon";

revoke update on table "public"."training_content" from "anon";

revoke delete on table "public"."training_content" from "authenticated";

revoke insert on table "public"."training_content" from "authenticated";

revoke references on table "public"."training_content" from "authenticated";

revoke select on table "public"."training_content" from "authenticated";

revoke trigger on table "public"."training_content" from "authenticated";

revoke truncate on table "public"."training_content" from "authenticated";

revoke update on table "public"."training_content" from "authenticated";

revoke delete on table "public"."training_content" from "service_role";

revoke insert on table "public"."training_content" from "service_role";

revoke references on table "public"."training_content" from "service_role";

revoke select on table "public"."training_content" from "service_role";

revoke trigger on table "public"."training_content" from "service_role";

revoke truncate on table "public"."training_content" from "service_role";

revoke update on table "public"."training_content" from "service_role";

revoke delete on table "public"."unit_alias" from "anon";

revoke insert on table "public"."unit_alias" from "anon";

revoke references on table "public"."unit_alias" from "anon";

revoke select on table "public"."unit_alias" from "anon";

revoke trigger on table "public"."unit_alias" from "anon";

revoke truncate on table "public"."unit_alias" from "anon";

revoke update on table "public"."unit_alias" from "anon";

revoke delete on table "public"."unit_alias" from "authenticated";

revoke insert on table "public"."unit_alias" from "authenticated";

revoke references on table "public"."unit_alias" from "authenticated";

revoke select on table "public"."unit_alias" from "authenticated";

revoke trigger on table "public"."unit_alias" from "authenticated";

revoke truncate on table "public"."unit_alias" from "authenticated";

revoke update on table "public"."unit_alias" from "authenticated";

revoke delete on table "public"."unit_alias" from "service_role";

revoke insert on table "public"."unit_alias" from "service_role";

revoke references on table "public"."unit_alias" from "service_role";

revoke select on table "public"."unit_alias" from "service_role";

revoke trigger on table "public"."unit_alias" from "service_role";

revoke truncate on table "public"."unit_alias" from "service_role";

revoke update on table "public"."unit_alias" from "service_role";

revoke delete on table "public"."unit_catalog" from "anon";

revoke insert on table "public"."unit_catalog" from "anon";

revoke references on table "public"."unit_catalog" from "anon";

revoke select on table "public"."unit_catalog" from "anon";

revoke trigger on table "public"."unit_catalog" from "anon";

revoke truncate on table "public"."unit_catalog" from "anon";

revoke update on table "public"."unit_catalog" from "anon";

revoke delete on table "public"."unit_catalog" from "authenticated";

revoke insert on table "public"."unit_catalog" from "authenticated";

revoke references on table "public"."unit_catalog" from "authenticated";

revoke select on table "public"."unit_catalog" from "authenticated";

revoke trigger on table "public"."unit_catalog" from "authenticated";

revoke truncate on table "public"."unit_catalog" from "authenticated";

revoke update on table "public"."unit_catalog" from "authenticated";

revoke delete on table "public"."unit_catalog" from "service_role";

revoke insert on table "public"."unit_catalog" from "service_role";

revoke references on table "public"."unit_catalog" from "service_role";

revoke select on table "public"."unit_catalog" from "service_role";

revoke trigger on table "public"."unit_catalog" from "service_role";

revoke truncate on table "public"."unit_catalog" from "service_role";

revoke update on table "public"."unit_catalog" from "service_role";

revoke delete on table "public"."user_pron_attempts" from "anon";

revoke insert on table "public"."user_pron_attempts" from "anon";

revoke references on table "public"."user_pron_attempts" from "anon";

revoke select on table "public"."user_pron_attempts" from "anon";

revoke trigger on table "public"."user_pron_attempts" from "anon";

revoke truncate on table "public"."user_pron_attempts" from "anon";

revoke update on table "public"."user_pron_attempts" from "anon";

revoke delete on table "public"."user_pron_attempts" from "authenticated";

revoke insert on table "public"."user_pron_attempts" from "authenticated";

revoke references on table "public"."user_pron_attempts" from "authenticated";

revoke select on table "public"."user_pron_attempts" from "authenticated";

revoke trigger on table "public"."user_pron_attempts" from "authenticated";

revoke truncate on table "public"."user_pron_attempts" from "authenticated";

revoke update on table "public"."user_pron_attempts" from "authenticated";

revoke delete on table "public"."user_pron_attempts" from "service_role";

revoke insert on table "public"."user_pron_attempts" from "service_role";

revoke references on table "public"."user_pron_attempts" from "service_role";

revoke select on table "public"."user_pron_attempts" from "service_role";

revoke trigger on table "public"."user_pron_attempts" from "service_role";

revoke truncate on table "public"."user_pron_attempts" from "service_role";

revoke update on table "public"."user_pron_attempts" from "service_role";

revoke delete on table "public"."user_pron_verifications" from "anon";

revoke insert on table "public"."user_pron_verifications" from "anon";

revoke references on table "public"."user_pron_verifications" from "anon";

revoke select on table "public"."user_pron_verifications" from "anon";

revoke trigger on table "public"."user_pron_verifications" from "anon";

revoke truncate on table "public"."user_pron_verifications" from "anon";

revoke update on table "public"."user_pron_verifications" from "anon";

revoke delete on table "public"."user_pron_verifications" from "authenticated";

revoke insert on table "public"."user_pron_verifications" from "authenticated";

revoke references on table "public"."user_pron_verifications" from "authenticated";

revoke select on table "public"."user_pron_verifications" from "authenticated";

revoke trigger on table "public"."user_pron_verifications" from "authenticated";

revoke truncate on table "public"."user_pron_verifications" from "authenticated";

revoke update on table "public"."user_pron_verifications" from "authenticated";

revoke delete on table "public"."user_pron_verifications" from "service_role";

revoke insert on table "public"."user_pron_verifications" from "service_role";

revoke references on table "public"."user_pron_verifications" from "service_role";

revoke select on table "public"."user_pron_verifications" from "service_role";

revoke trigger on table "public"."user_pron_verifications" from "service_role";

revoke truncate on table "public"."user_pron_verifications" from "service_role";

revoke update on table "public"."user_pron_verifications" from "service_role";

revoke delete on table "public"."user_sentence_progress" from "anon";

revoke insert on table "public"."user_sentence_progress" from "anon";

revoke references on table "public"."user_sentence_progress" from "anon";

revoke select on table "public"."user_sentence_progress" from "anon";

revoke trigger on table "public"."user_sentence_progress" from "anon";

revoke truncate on table "public"."user_sentence_progress" from "anon";

revoke update on table "public"."user_sentence_progress" from "anon";

revoke delete on table "public"."user_sentence_progress" from "authenticated";

revoke insert on table "public"."user_sentence_progress" from "authenticated";

revoke references on table "public"."user_sentence_progress" from "authenticated";

revoke select on table "public"."user_sentence_progress" from "authenticated";

revoke trigger on table "public"."user_sentence_progress" from "authenticated";

revoke truncate on table "public"."user_sentence_progress" from "authenticated";

revoke update on table "public"."user_sentence_progress" from "authenticated";

revoke delete on table "public"."user_sentence_progress" from "service_role";

revoke insert on table "public"."user_sentence_progress" from "service_role";

revoke references on table "public"."user_sentence_progress" from "service_role";

revoke select on table "public"."user_sentence_progress" from "service_role";

revoke trigger on table "public"."user_sentence_progress" from "service_role";

revoke truncate on table "public"."user_sentence_progress" from "service_role";

revoke update on table "public"."user_sentence_progress" from "service_role";

revoke delete on table "public"."user_unit_stats" from "anon";

revoke insert on table "public"."user_unit_stats" from "anon";

revoke references on table "public"."user_unit_stats" from "anon";

revoke select on table "public"."user_unit_stats" from "anon";

revoke trigger on table "public"."user_unit_stats" from "anon";

revoke truncate on table "public"."user_unit_stats" from "anon";

revoke update on table "public"."user_unit_stats" from "anon";

revoke delete on table "public"."user_unit_stats" from "authenticated";

revoke insert on table "public"."user_unit_stats" from "authenticated";

revoke references on table "public"."user_unit_stats" from "authenticated";

revoke select on table "public"."user_unit_stats" from "authenticated";

revoke trigger on table "public"."user_unit_stats" from "authenticated";

revoke truncate on table "public"."user_unit_stats" from "authenticated";

revoke update on table "public"."user_unit_stats" from "authenticated";

revoke delete on table "public"."user_unit_stats" from "service_role";

revoke insert on table "public"."user_unit_stats" from "service_role";

revoke references on table "public"."user_unit_stats" from "service_role";

revoke select on table "public"."user_unit_stats" from "service_role";

revoke trigger on table "public"."user_unit_stats" from "service_role";

revoke truncate on table "public"."user_unit_stats" from "service_role";

revoke update on table "public"."user_unit_stats" from "service_role";

revoke delete on table "public"."zh_pinyin_units" from "anon";

revoke insert on table "public"."zh_pinyin_units" from "anon";

revoke references on table "public"."zh_pinyin_units" from "anon";

revoke select on table "public"."zh_pinyin_units" from "anon";

revoke trigger on table "public"."zh_pinyin_units" from "anon";

revoke truncate on table "public"."zh_pinyin_units" from "anon";

revoke update on table "public"."zh_pinyin_units" from "anon";

revoke delete on table "public"."zh_pinyin_units" from "authenticated";

revoke insert on table "public"."zh_pinyin_units" from "authenticated";

revoke references on table "public"."zh_pinyin_units" from "authenticated";

revoke select on table "public"."zh_pinyin_units" from "authenticated";

revoke trigger on table "public"."zh_pinyin_units" from "authenticated";

revoke truncate on table "public"."zh_pinyin_units" from "authenticated";

revoke update on table "public"."zh_pinyin_units" from "authenticated";

revoke delete on table "public"."zh_pinyin_units" from "service_role";

revoke insert on table "public"."zh_pinyin_units" from "service_role";

revoke references on table "public"."zh_pinyin_units" from "service_role";

revoke select on table "public"."zh_pinyin_units" from "service_role";

revoke trigger on table "public"."zh_pinyin_units" from "service_role";

revoke truncate on table "public"."zh_pinyin_units" from "service_role";

revoke update on table "public"."zh_pinyin_units" from "service_role";

alter table "public"."en_phoneme_units" drop constraint if exists "en_phoneme_units_symbol_key";

drop index if exists "public"."en_phoneme_units_symbol_key";

-- 保留 en_phoneme_units / ja_phoneme_units，为发音系统提供支撑
-- drop table "public"."en_phoneme_units";
-- drop table "public"."ja_phoneme_units";
*/

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.exec_sql(sql text)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  EXECUTE sql;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.generate_invitation_code()
 RETURNS text
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
    DECLARE
      chars text := 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      result text := '';
      i integer;
    BEGIN
      FOR i IN 1..8 LOOP
        result := result || substr(chars, floor(random() * length(chars) + 1)::integer, 1);
      END LOOP;
      RETURN result;
    END;
    $function$
;

CREATE OR REPLACE FUNCTION public.get_table_columns(table_name_param text)
 RETURNS TABLE(column_name text, data_type text, is_nullable text, column_default text, ordinal_position integer)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    c.column_name::text,
    c.data_type::text,
    c.is_nullable::text,
    c.column_default::text,
    c.ordinal_position::integer
  FROM information_schema.columns c
  WHERE c.table_schema = 'public'
    AND c.table_name = table_name_param
  ORDER BY c.ordinal_position;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_table_list()
 RETURNS TABLE(table_name text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT t.table_name::text
  FROM information_schema.tables t
  WHERE t.table_schema = 'public'
    AND t.table_name != 'spatial_ref_sys'
    AND t.table_type = 'BASE TABLE'
  ORDER BY t.table_name;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.insert_shadowing_item(p_lang text, p_level integer, p_title text, p_text text, p_audio_url text, p_duration_ms integer DEFAULT NULL::integer, p_tokens integer DEFAULT NULL::integer)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
declare
  v_id uuid;
begin
  insert into public.shadowing_items (
    lang, level, title, text, audio_url, duration_ms, tokens
  ) values (
    p_lang, p_level, p_title, p_text, p_audio_url, p_duration_ms, p_tokens
  ) returning id into v_id;
  
  return v_id;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.insert_shadowing_item(p_lang text, p_level integer, p_title text, p_text text, p_audio_url text, p_duration_ms integer DEFAULT NULL::integer, p_tokens integer DEFAULT NULL::integer, p_cefr text DEFAULT NULL::text, p_meta jsonb DEFAULT '{}'::jsonb)
 RETURNS uuid
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
    DECLARE
      new_id uuid;
    BEGIN
      INSERT INTO public.shadowing_items (
        lang, level, title, text, audio_url, duration_ms, tokens, cefr, meta
      ) VALUES (
        p_lang, p_level, p_title, p_text, p_audio_url, p_duration_ms, p_tokens, p_cefr, p_meta
      ) RETURNING id INTO new_id;

      RETURN new_id;
    END;
    $function$
;

CREATE OR REPLACE FUNCTION public.is_admin()
 RETURNS boolean
 LANGUAGE sql
 STABLE
AS $function$
  select exists(select 1 from public.profiles where id = auth.uid() and role='admin')
$function$
;

CREATE OR REPLACE FUNCTION public.set_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  NEW.updated_at := now();
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.trigger_set_timestamp()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_api_usage_logs_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
    BEGIN
      NEW.updated_at = NOW();
      RETURN NEW;
    END;
    $function$
;

CREATE OR REPLACE FUNCTION public.update_default_user_permissions_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
begin
  new.updated_at = now();
  return new;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.update_shadowing_sessions_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_updated_at_column()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
begin
  new.updated_at = now();
  return new;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.update_user_api_limits_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
begin
  new.updated_at = now();
  return new;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.update_user_permissions_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
begin
  new.updated_at = now();
  return new;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.validate_invitation_code(code_text text)
 RETURNS TABLE(is_valid boolean, code_id uuid, max_uses integer, used_count integer, expires_at timestamp with time zone, permissions jsonb, error_message text)
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
    DECLARE
      invitation_record record;
    BEGIN
      -- 查找邀请码
      SELECT * INTO invitation_record
      FROM public.invitation_codes
      WHERE code = code_text AND is_active = true;

      IF NOT FOUND THEN
        RETURN QUERY SELECT false, null::uuid, 0, 0, null::timestamptz, null::jsonb, '邀请码不存在或已失效'::text;
        RETURN;
      END IF;

      -- 检查是否过期
      IF invitation_record.expires_at IS NOT NULL AND invitation_record.expires_at < NOW() THEN
        RETURN QUERY SELECT false, invitation_record.id, invitation_record.max_uses, invitation_record.used_count,
                           invitation_record.expires_at, invitation_record.permissions, '邀请码已过期'::text;
        RETURN;
      END IF;

      -- 检查使用次数
      IF invitation_record.used_count >= invitation_record.max_uses THEN
        RETURN QUERY SELECT false, invitation_record.id, invitation_record.max_uses, invitation_record.used_count,
                           invitation_record.expires_at, invitation_record.permissions, '邀请码使用次数已达上限'::text;
        RETURN;
      END IF;

      -- 邀请码有效
      RETURN QUERY SELECT true, invitation_record.id, invitation_record.max_uses, invitation_record.used_count,
                         invitation_record.expires_at, invitation_record.permissions, null::text;
    END;
    $function$
;
