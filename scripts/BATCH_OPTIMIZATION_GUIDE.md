# 批量生成性能优化指南

## 🚀 优化方案概述

本次优化通过以下四个核心策略大幅提升批量生成速度：

### 1. 并发池处理 (Concurrency Pool)

- **原理**: 将串行处理改为受控并发池
- **效果**: 4-8倍速度提升
- **配置**: `concurrency` 参数 (1-8)
- **建议**: 4-6个并发，避免API限制

### 2. 批量生成 (Batch Generation)

- **原理**: 一次API调用生成多条内容
- **效果**: 3-5倍吞吐量提升
- **配置**: `batch_size` 参数 (1-10)
- **建议**: 3-5条/次，平衡质量和速度

### 3. 智能重试 (Smart Retry)

- **原理**: 对429/503错误进行指数退避重试
- **效果**: 减少因网络问题导致的失败
- **配置**: `retries` 参数 (0-5)
- **建议**: 2-3次重试

### 4. 节流控制 (Throttling)

- **原理**: 在任务间添加延迟，避免触发API限制
- **效果**: 减少429错误，提高成功率
- **配置**: `throttle_ms` 参数 (0-2000ms)
- **建议**: 100-300ms，根据API限制调整

## 📊 性能对比

| 模式     | 并发数 | 批量大小 | 预计提升 | 适用场景    |
| -------- | ------ | -------- | -------- | ----------- |
| 原始串行 | 1      | 1        | 1x       | 测试/小批量 |
| 并发模式 | 4      | 1        | 3-4x     | 中等批量    |
| 批量模式 | 1      | 3        | 2-3x     | 质量优先    |
| 优化组合 | 4      | 3        | 8-12x    | 大批量生产  |

## 🛠️ 使用方法

### 1. 基础配置

```typescript
const params = {
  kind: 'cloze', // 生成类型
  lang: 'ja', // 目标语言
  levels: [3, 4], // 难度等级
  topicsText: 'Daily life\nCampus', // 主题列表
  perCombo: 2, // 每组合数量
  provider: 'openrouter', // AI提供商
  model: 'openai/gpt-4o-mini', // 模型选择
};
```

### 2. 性能参数

```typescript
const performanceParams = {
  concurrency: 4, // 并发数 (1-8)
  batch_size: 3, // 批量大小 (1-10)
  retries: 2, // 重试次数 (0-5)
  throttle_ms: 100, // 节流延迟 (0-2000ms)
};
```

### 3. 运行测试

```bash
# 设置认证token
export TEST_AUTH_TOKEN="your_auth_token_here"

# 运行性能测试
node scripts/batch-generation-performance-test.js
```

## ⚡ 最佳实践

### 1. 参数调优

- **小批量 (< 20条)**: 并发2-3, 批量1-2
- **中批量 (20-100条)**: 并发4-6, 批量3-5
- **大批量 (> 100条)**: 并发6-8, 批量5-8

### 2. 错误处理

- 监控429错误率，超过10%增加节流
- 网络不稳定时增加重试次数
- 大批量任务建议分批执行

### 3. 成本控制

- 批量生成可减少API调用次数
- 并发控制避免超出API限制
- 合理设置重试避免重复计费

## 🔍 监控指标

### 关键指标

- **吞吐量**: 条/秒 (越高越好)
- **成功率**: 成功数/总数 (目标 > 95%)
- **Token效率**: tokens/条 (越低越好)
- **错误率**: 错误数/总数 (目标 < 5%)

### 性能基准

- **基础模式**: 0.5-1 条/秒
- **优化模式**: 4-8 条/秒
- **理想状态**: 8-12 条/秒

## ⚠️ 注意事项

### 1. API限制

- OpenRouter: 60 requests/min
- DeepSeek: 30 requests/min
- 超出限制会返回429错误

### 2. 内存使用

- 高并发会增加内存使用
- 大批量生成需要更多内存
- 建议监控服务器内存使用

### 3. 数据库性能

- 批量插入比单条插入快
- 建议定期清理草稿表
- 考虑添加数据库索引

## 🔧 进一步优化

### 1. 模型分层

- 草稿阶段使用快速模型
- 审核阶段使用高质量模型
- 可节省50%以上成本

### 2. 缓存机制

- 相同参数组合缓存结果
- 避免重复生成相同内容
- 显著提升重复任务速度

### 3. 异步处理

- 将大批量任务放入队列
- 后台异步处理
- 提供任务状态查询

## 🐛 故障排除

### 常见问题

1. **429错误过多**: 降低并发数，增加节流
2. **生成质量下降**: 降低批量大小
3. **内存不足**: 减少并发数
4. **数据库超时**: 检查索引，优化查询

### 调试技巧

- 查看详细日志了解错误原因
- 使用性能测试脚本验证配置
- 监控API使用量和限制
- 定期检查数据库性能

## 📞 技术支持

如有问题，请检查：

1. 认证token是否有效
2. API配额是否充足
3. 网络连接是否稳定
4. 数据库是否正常

更多技术细节请参考代码注释和API文档。
