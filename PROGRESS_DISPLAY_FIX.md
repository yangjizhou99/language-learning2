# 备份进度显示修复说明

## 问题描述

备份功能能正常工作，但是进度显示有问题，用户无法看到实时的备份进度。

## 修复内容

### 1. 数据库备份进度优化

#### 表导出进度
- **原来**：只显示当前正在导出的表名
- **现在**：显示 `正在导出表: table_name (1/33)`
- **进度计算**：基于已处理的表数量

#### 数据导出进度
- **新增**：显示数据批次进度
- **格式**：`正在导出表: table_name (1/33) - 数据批次 1/5`
- **更新频率**：每处理1000条记录更新一次

### 2. 存储桶备份进度优化

#### 文件统计阶段
- **新增**：显示找到的总文件数
- **消息**：`找到 150 个文件，开始下载...`

#### 下载进度
- **原来**：进度更新不够频繁
- **现在**：每下载一个文件就更新进度
- **格式**：`正在下载存储桶: bucket_name (5/150)`
- **进度计算**：基于已下载的文件数量

### 3. 进度计算优化

#### 数据库备份进度范围
- **0-10%**：连接数据库和获取表列表
- **10-90%**：导出表结构和数据
- **90-100%**：保存SQL文件

#### 存储桶备份进度范围
- **0-10%**：连接存储服务和统计文件
- **10-90%**：下载文件
- **90-100%**：计算目录大小和完成

## 技术实现

### 进度更新频率

```typescript
// 数据库备份 - 每个表更新一次
const progressPercent = Math.round(10 + (i / tables.length) * 80);
task.message = `正在导出表: ${tableName} (${i + 1}/${tables.length})`;

// 存储桶备份 - 每个文件更新一次
const progressPercent = Math.round(10 + (downloadedFiles / totalFiles) * 80);
task.message = `正在下载存储桶: ${bucket.name} (${downloadedFiles}/${totalFiles})`;
```

### 进度条更新

```typescript
task.progress = progressPercent;
backupTasks.set(taskId, task);
```

## 用户体验改进

### 1. 更详细的状态信息
- 显示当前处理的项目
- 显示总体进度 (x/y)
- 显示具体操作阶段

### 2. 更频繁的进度更新
- 数据库备份：每个表 + 每批数据更新
- 存储桶备份：每个文件更新

### 3. 更准确的进度计算
- 基于实际工作量计算进度
- 避免进度条跳跃或停滞

## 预期效果

### 数据库备份进度示例
```
正在连接数据库... (0%)
找到 33 个表，开始导出... (10%)
正在导出表: profiles (1/33) (12%)
正在导出表: profiles (1/33) - 数据批次 1/3 (15%)
正在导出表: articles (2/33) (18%)
...
数据库备份完成，共导出 33 个表 (100%)
```

### 存储桶备份进度示例
```
正在连接存储服务... (0%)
找到 150 个文件，开始下载... (10%)
正在下载存储桶: audio (5/150) (15%)
正在下载存储桶: audio (10/150) (20%)
...
存储桶备份完成，共下载 150 个文件 (100%)
```

## 注意事项

1. **性能考虑**：频繁的进度更新可能影响性能，但影响很小
2. **网络延迟**：进度更新基于操作完成，不是基于时间
3. **错误处理**：即使某个文件下载失败，进度仍会继续更新

## 测试建议

1. **小数据量测试**：先用少量数据测试进度显示
2. **大数据量测试**：测试大量数据时的进度更新
3. **网络中断测试**：测试网络问题时的进度显示
4. **长时间运行测试**：测试长时间备份的进度稳定性

现在备份功能应该能显示详细的实时进度了！
