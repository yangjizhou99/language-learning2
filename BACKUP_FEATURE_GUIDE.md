# 数据备份功能使用指南

## 功能概述

管理员界面新增了完整的数据备份和恢复功能，可以将整个数据库和存储桶中的文件备份到指定的本地文件夹中，并支持从备份文件恢复数据。

## 功能特性

### 备份功能
- **数据库备份**：导出所有表结构和数据为SQL文件
- **存储桶备份**：下载所有存储桶中的文件到本地
- **实时进度**：显示备份进度和状态
- **文件下载**：支持下载ZIP格式的备份文件
- **路径配置**：可自定义备份保存路径

### 恢复功能
- **ZIP文件支持**：支持上传ZIP格式的备份文件
- **数据库恢复**：从SQL文件恢复数据库结构和数据
- **存储桶恢复**：恢复存储桶中的文件
- **错误处理**：智能处理恢复过程中的错误

## 使用方法

### 1. 访问备份管理页面

1. 登录管理员账户
2. 在管理员导航中点击"数据备份"
3. 进入备份管理页面

### 2. 创建备份

1. **设置备份路径**
   - 在"备份路径"输入框中输入本地文件夹路径
   - 默认路径：`D:\backups\language-learning`
   - 确保路径存在且有写入权限

2. **开始备份**
   - 点击"开始备份"按钮
   - 系统将同时进行数据库和存储桶备份
   - 页面会显示实时进度和状态

3. **下载备份文件**
   - 备份完成后，可以点击"下载"按钮下载ZIP文件
   - 文件包含数据库SQL文件和存储桶文件

### 3. 恢复备份

1. **选择备份文件**
   - 点击"选择备份文件"按钮
   - 选择之前下载的ZIP格式备份文件

2. **开始恢复**
   - 点击"开始恢复"按钮
   - 系统将解压文件并恢复数据
   - 恢复完成后会显示成功消息

## 技术实现

### 数据库备份
- 使用Supabase服务角色权限访问数据库
- 通过`information_schema`获取表结构信息
- 生成完整的SQL DDL和DML语句
- 支持所有PostgreSQL数据类型

### 存储桶备份
- 遍历所有存储桶和文件
- 下载文件到本地目录结构
- 保持原有的目录层级关系
- 支持大文件的分批处理

### 文件压缩
- 使用`archiver`库创建ZIP文件
- 支持数据库文件和存储桶文件的打包
- 自动生成下载链接

### 恢复机制
- 使用`yauzl`库解压ZIP文件
- 通过`exec_sql`函数执行SQL语句
- 智能错误处理，跳过非致命错误
- 自动创建存储桶和上传文件

## 安全考虑

### 权限控制
- 只有管理员可以访问备份功能
- 使用服务角色权限进行数据库操作
- 文件操作限制在指定目录内

### 数据安全
- 备份文件包含敏感数据，请妥善保管
- 建议定期清理临时文件
- 恢复操作会覆盖现有数据，请谨慎操作

## 故障排除

### 常见问题

1. **备份路径权限错误**
   - 确保指定的路径存在
   - 检查应用是否有写入权限
   - 尝试使用绝对路径

2. **数据库连接失败**
   - 检查Supabase服务角色密钥配置
   - 确认数据库连接正常
   - 查看控制台错误日志

3. **存储桶访问失败**
   - 检查存储桶权限设置
   - 确认文件存在且可访问
   - 查看网络连接状态

4. **恢复失败**
   - 检查备份文件是否完整
   - 确认数据库有足够空间
   - 查看错误日志获取详细信息

### 日志查看

备份和恢复过程中的详细日志会输出到控制台，包括：
- 数据库操作日志
- 文件传输进度
- 错误信息和堆栈跟踪

## 性能优化

### 备份优化
- 大表数据分批导出
- 存储桶文件并发下载
- 进度实时更新

### 恢复优化
- SQL语句批量执行
- 文件并发上传
- 错误快速跳过

## 维护建议

1. **定期备份**
   - 建议每日进行增量备份
   - 每周进行完整备份
   - 重要更新前手动备份

2. **备份验证**
   - 定期测试备份文件完整性
   - 验证恢复功能正常工作
   - 检查备份文件大小合理性

3. **存储管理**
   - 定期清理旧备份文件
   - 监控磁盘空间使用
   - 考虑使用云存储备份

## 扩展功能

未来可以考虑添加的功能：
- 自动定时备份
- 增量备份支持
- 备份文件加密
- 云存储集成
- 备份历史管理
- 邮件通知功能

## 注意事项

1. **数据一致性**：备份过程中如有数据变更，可能影响备份一致性
2. **存储空间**：确保有足够的磁盘空间存储备份文件
3. **网络稳定**：大文件传输需要稳定的网络连接
4. **恢复测试**：定期测试恢复功能确保备份可用性
5. **权限管理**：备份文件包含敏感数据，注意访问权限控制
