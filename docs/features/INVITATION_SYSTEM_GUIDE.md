# é‚€è¯·ç æ³¨å†Œç³»ç»Ÿä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

é‚€è¯·ç æ³¨å†Œç³»ç»Ÿä¸ºæ‚¨çš„è¯­è¨€å­¦ä¹ åº”ç”¨æä¾›äº†çµæ´»çš„æƒé™æ§åˆ¶æœºåˆ¶ã€‚ç®¡ç†å‘˜å¯ä»¥åˆ›å»ºé‚€è¯·ç ï¼Œç”¨æˆ·é€šè¿‡é‚€è¯·ç æ³¨å†Œåè‡ªåŠ¨è·å¾—ç›¸åº”çš„æƒé™è®¾ç½®ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸ« é‚€è¯·ç ç®¡ç†

- **åˆ›å»ºé‚€è¯·ç **ï¼šç®¡ç†å‘˜å¯ä»¥åˆ›å»ºå¸¦æœ‰è‡ªå®šä¹‰æƒé™çš„é‚€è¯·ç 
- **æƒé™æ§åˆ¶**ï¼šç»†ç²’åº¦æ§åˆ¶ç”¨æˆ·å¯è®¿é—®çš„åŠŸèƒ½æ¨¡å—
- **ä½¿ç”¨é™åˆ¶**ï¼šè®¾ç½®æœ€å¤§ä½¿ç”¨æ¬¡æ•°å’Œè¿‡æœŸæ—¶é—´
- **çŠ¶æ€ç®¡ç†**ï¼šå¯ç”¨/ç¦ç”¨é‚€è¯·ç 
- **ä½¿ç”¨ç»Ÿè®¡**ï¼šæŸ¥çœ‹é‚€è¯·ç ä½¿ç”¨æƒ…å†µ

### ğŸ” æƒé™ç³»ç»Ÿ

- **æ¨¡å—æƒé™**ï¼šæ§åˆ¶ç”¨æˆ·å¯è®¿é—®çš„ç»ƒä¹ æ¨¡å—ï¼ˆè·Ÿè¯»ã€å®Œå½¢å¡«ç©ºã€å¯¹é½ç»ƒä¹ ã€æ–‡ç« é˜…è¯»ï¼‰
- **AIåŠŸèƒ½**ï¼šæ§åˆ¶ç”¨æˆ·æ˜¯å¦å¯ä»¥ä½¿ç”¨AIåŠŸèƒ½
- **è¯­è¨€é™åˆ¶**ï¼šé™åˆ¶ç”¨æˆ·å¯å­¦ä¹ çš„è¯­è¨€
- **éš¾åº¦ç­‰çº§**ï¼šæ§åˆ¶ç”¨æˆ·å¯è®¿é—®çš„éš¾åº¦ç­‰çº§
- **æ¯æ—¥é™åˆ¶**ï¼šè®¾ç½®æ¯æ—¥æœ€å¤§å°è¯•æ¬¡æ•°
- **APIä½¿ç”¨é™åˆ¶**ï¼šè®¾ç½®ç”¨æˆ·çš„APIè°ƒç”¨é™åˆ¶ï¼ˆè°ƒç”¨æ¬¡æ•°ã€Tokené™åˆ¶ã€è´¹ç”¨é™åˆ¶ï¼‰
- **APIå¯†é’¥é…ç½®**ï¼šä¸ºé‚€è¯·ç ç”¨æˆ·é…ç½®ä¸“ç”¨çš„APIå¯†é’¥
- **æ¨¡å‹æƒé™é…ç½®**ï¼šæ§åˆ¶ç”¨æˆ·å¯ä»¥ä½¿ç”¨çš„AIæ¨¡å‹å’Œé™åˆ¶
- **æƒé™è¿‡æœŸ**ï¼šæ”¯æŒæƒé™è¿‡æœŸæ—¶é—´è®¾ç½®

### ğŸ“‹ æƒé™æ¥æºè§„åˆ™

- **é‚€è¯·ç æ³¨å†Œ**ï¼šä½¿ç”¨é‚€è¯·ç çš„æƒé™è®¾ç½®ï¼Œå®Œå…¨è¦†ç›–ä»»ä½•ç°æœ‰æƒé™
- **ç›´æ¥æ³¨å†Œ**ï¼šä½¿ç”¨ç³»ç»Ÿé»˜è®¤æƒé™è®¾ç½®
- **æ— å†²çª**ï¼šä¸¤ç§æ³¨å†Œæ–¹å¼ä½¿ç”¨ä¸åŒçš„æƒé™æ¥æºï¼Œä¸ä¼šäº§ç”Ÿå†²çª

### ğŸ‘¤ ç”¨æˆ·æ³¨å†Œ

- **é‚€è¯·ç éªŒè¯**ï¼šæ³¨å†Œå‰éªŒè¯é‚€è¯·ç æœ‰æ•ˆæ€§
- **æƒé™é¢„è§ˆ**ï¼šæ˜¾ç¤ºé‚€è¯·ç å¯¹åº”çš„æƒé™è®¾ç½®
- **è‡ªåŠ¨æƒé™åº”ç”¨**ï¼šæ³¨å†ŒæˆåŠŸåè‡ªåŠ¨åº”ç”¨é‚€è¯·ç æƒé™
- **æ— ç¼ä½“éªŒ**ï¼šæ³¨å†Œåè‡ªåŠ¨ç™»å½•

## ä½¿ç”¨æµç¨‹

### ç®¡ç†å‘˜æ“ä½œ

1. **è®¿é—®é‚€è¯·ç ç®¡ç†**
   - ç™»å½•ç®¡ç†å‘˜è´¦å·
   - è¿›å…¥ `/admin/invitations` é¡µé¢

2. **åˆ›å»ºé‚€è¯·ç **
   - ç‚¹å‡»"åˆ›å»ºé‚€è¯·ç "æŒ‰é’®
   - è®¾ç½®æœ€å¤§ä½¿ç”¨æ¬¡æ•°ï¼ˆé»˜è®¤1æ¬¡ï¼‰
   - è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰
   - é…ç½®æƒé™è®¾ç½®ï¼š
     - âœ“ è·Ÿè¯»ç»ƒä¹ 
     - âœ“ å®Œå½¢å¡«ç©º
     - âœ“ å¯¹é½ç»ƒä¹ 
     - âœ“ æ–‡ç« é˜…è¯»
     - âœ“ AIåŠŸèƒ½
     - âœ“ APIå¯†é’¥é…ç½®ï¼ˆå¯é€‰ï¼‰
     - âœ“ APIä½¿ç”¨é™åˆ¶ï¼ˆå¯é€‰ï¼‰
     - âœ“ æ¨¡å‹æƒé™é…ç½®ï¼ˆå¯é€‰ï¼‰
   - æ·»åŠ æè¿°ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
   - ç‚¹å‡»"åˆ›å»º"ç”Ÿæˆé‚€è¯·ç 

3. **ç®¡ç†é‚€è¯·ç **
   - æŸ¥çœ‹é‚€è¯·ç åˆ—è¡¨
   - å¤åˆ¶é‚€è¯·ç ç»™ç”¨æˆ·
   - å¯ç”¨/ç¦ç”¨é‚€è¯·ç 
   - åˆ é™¤ä¸éœ€è¦çš„é‚€è¯·ç 
   - æŸ¥çœ‹ä½¿ç”¨ç»Ÿè®¡

### ç”¨æˆ·æ“ä½œ

1. **è·å–é‚€è¯·ç **
   - ä»ç®¡ç†å‘˜å¤„è·å–8ä½é‚€è¯·ç 

2. **æ³¨å†Œè´¦å·**
   - è®¿é—® `/auth` é¡µé¢
   - ç‚¹å‡»"é‚€è¯·ç æ³¨å†Œ"å±•å¼€æ³¨å†Œè¡¨å•
   - è¾“å…¥é‚€è¯·ç å¹¶ç‚¹å‡»"éªŒè¯"
   - æŸ¥çœ‹æƒé™é¢„è§ˆ
   - å¡«å†™é‚®ç®±å’Œå¯†ç 
   - ç‚¹å‡»"ä½¿ç”¨é‚€è¯·ç æ³¨å†Œ"

3. **å¼€å§‹ä½¿ç”¨**
   - æ³¨å†ŒæˆåŠŸåè‡ªåŠ¨ç™»å½•
   - æ ¹æ®é‚€è¯·ç æƒé™è®¿é—®ç›¸åº”åŠŸèƒ½

## æ•°æ®åº“ç»“æ„

### invitation_codes è¡¨

```sql
- id: ä¸»é”®
- code: 8ä½é‚€è¯·ç ï¼ˆå”¯ä¸€ï¼‰
- created_by: åˆ›å»ºè€…ID
- max_uses: æœ€å¤§ä½¿ç”¨æ¬¡æ•°
- used_count: å·²ä½¿ç”¨æ¬¡æ•°
- expires_at: è¿‡æœŸæ—¶é—´
- permissions: æƒé™è®¾ç½®ï¼ˆJSONï¼‰
- description: æè¿°ä¿¡æ¯
- is_active: æ˜¯å¦æ¿€æ´»
- created_at: åˆ›å»ºæ—¶é—´
- updated_at: æ›´æ–°æ—¶é—´
```

### invitation_uses è¡¨

```sql
- id: ä¸»é”®
- code_id: é‚€è¯·ç ID
- used_by: ä½¿ç”¨è€…ID
- used_at: ä½¿ç”¨æ—¶é—´
```

### profiles è¡¨ï¼ˆæ–°å¢å­—æ®µï¼‰

```sql
- invited_by: é‚€è¯·è€…ID
- invitation_code_id: ä½¿ç”¨çš„é‚€è¯·ç ID
- invitation_used_at: ä½¿ç”¨é‚€è¯·ç çš„æ—¶é—´
```

## API æ¥å£

### ç®¡ç†å‘˜æ¥å£

#### è·å–é‚€è¯·ç åˆ—è¡¨

```
GET /api/admin/invitations
Query: page, limit, created_by
```

#### åˆ›å»ºé‚€è¯·ç 

```
POST /api/admin/invitations
Body: {
  max_uses: number,
  expires_at?: string,
  permissions: InvitationPermissions,
  description?: string
}
```

#### æ›´æ–°é‚€è¯·ç 

```
PUT /api/admin/invitations/[id]
Body: {
  max_uses?: number,
  expires_at?: string,
  permissions?: InvitationPermissions,
  description?: string,
  is_active?: boolean
}
```

#### åˆ é™¤é‚€è¯·ç 

```
DELETE /api/admin/invitations/[id]
```

#### è·å–ä½¿ç”¨è®°å½•

```
GET /api/admin/invitations/[id]/uses
Query: page, limit
```

### ç”¨æˆ·æ¥å£

#### éªŒè¯é‚€è¯·ç 

```
POST /api/auth/validate-invitation
Body: { code: string }
```

#### ä½¿ç”¨é‚€è¯·ç æ³¨å†Œ

```
POST /api/auth/register-with-invitation
Body: {
  email: string,
  password: string,
  invitation_code: string,
  username?: string,
  native_lang?: string,
  target_langs?: string[]
}
```

## æƒé™é…ç½®

### æƒé™æ¨¡æ¿ç¤ºä¾‹

```typescript
// åŸºç¡€ç”¨æˆ·æƒé™
{
  can_access_shadowing: true,
  can_access_cloze: true,
  can_access_alignment: false,
  can_access_articles: false,
  allowed_languages: ['en'],
  allowed_levels: [1, 2],
  max_daily_attempts: 20,
  ai_enabled: false
}

// é«˜çº§ç”¨æˆ·æƒé™
{
  can_access_shadowing: true,
  can_access_cloze: true,
  can_access_alignment: true,
  can_access_articles: true,
  allowed_languages: ['en', 'ja', 'zh'],
  allowed_levels: [1, 2, 3, 4, 5],
  max_daily_attempts: 100,
  ai_enabled: true,
  api_limits: {
    enabled: true,
    daily_calls_limit: 100,
    daily_tokens_limit: 50000,
    daily_cost_limit: 5.00,
    monthly_calls_limit: 2000,
    monthly_tokens_limit: 1000000,
    monthly_cost_limit: 100.00
  },
  api_keys: {
    deepseek: 'sk-xxx...',
    openrouter: 'sk-or-xxx...'
  },
  model_permissions: [
    {
      model_id: 'deepseek-chat',
      model_name: 'DeepSeek Chat',
      provider: 'deepseek',
      daily_limit: 50,
      token_limit: 100000,
      enabled: true
    },
    {
      model_id: 'openrouter/auto',
      model_name: 'OpenRouter Auto (æ¨è)',
      provider: 'openrouter',
      daily_limit: 30,
      token_limit: 80000,
      enabled: true
    }
  ]
}

// è¯•ç”¨æƒé™
{
  can_access_shadowing: true,
  can_access_cloze: false,
  can_access_alignment: false,
  can_access_articles: false,
  allowed_languages: ['en'],
  allowed_levels: [1],
  max_daily_attempts: 5,
  ai_enabled: false,
  expires_at: '2024-12-31T23:59:59Z'
}
```

## å®‰å…¨è€ƒè™‘

1. **é‚€è¯·ç ç”Ÿæˆ**ï¼šä½¿ç”¨å®‰å…¨çš„éšæœºç®—æ³•ç”Ÿæˆ8ä½å­—æ¯æ•°å­—ç»„åˆ
2. **æƒé™éªŒè¯**ï¼šæ¯æ¬¡APIè°ƒç”¨éƒ½ä¼šéªŒè¯ç”¨æˆ·æƒé™
3. **ä½¿ç”¨é™åˆ¶**ï¼šé˜²æ­¢é‚€è¯·ç è¢«é‡å¤ä½¿ç”¨
4. **è¿‡æœŸæ§åˆ¶**ï¼šæ”¯æŒé‚€è¯·ç å’Œæƒé™è¿‡æœŸæ—¶é—´
5. **ç®¡ç†å‘˜æƒé™**ï¼šåªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ›å»ºå’Œç®¡ç†é‚€è¯·ç 

## éƒ¨ç½²è¯´æ˜

1. **æ•°æ®åº“è¿ç§»**

   ```bash
   # åœ¨Supabaseæ§åˆ¶å°æ‰§è¡Œ
   # è¿è¡Œ supabase/migrations/20250120000010_create_invitation_system.sql
   ```

2. **ç¯å¢ƒå˜é‡**

   ```env
   # ç¡®ä¿å·²è®¾ç½®
   NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
   NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
   SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
   ```

3. **æƒé™è®¾ç½®**
   - ç¡®ä¿ç®¡ç†å‘˜è´¦å·æœ‰ `role = 'admin'`
   - æ£€æŸ¥RLSç­–ç•¥æ˜¯å¦æ­£ç¡®åº”ç”¨

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **é‚€è¯·ç éªŒè¯å¤±è´¥**
   - æ£€æŸ¥é‚€è¯·ç æ ¼å¼ï¼ˆ8ä½å­—æ¯æ•°å­—ï¼‰
   - ç¡®è®¤é‚€è¯·ç æœªè¿‡æœŸ
   - æ£€æŸ¥ä½¿ç”¨æ¬¡æ•°æ˜¯å¦å·²è¾¾ä¸Šé™

2. **æƒé™ä¸ç”Ÿæ•ˆ**
   - æ£€æŸ¥ç”¨æˆ·æƒé™è®°å½•æ˜¯å¦æ­£ç¡®åˆ›å»º
   - ç¡®è®¤æƒé™æ£€æŸ¥ä¸­é—´ä»¶æ˜¯å¦æ­£å¸¸å·¥ä½œ
   - æŸ¥çœ‹æ•°æ®åº“ä¸­çš„æƒé™æ•°æ®

3. **ç®¡ç†å‘˜æ— æ³•åˆ›å»ºé‚€è¯·ç **
   - ç¡®è®¤ç”¨æˆ·è§’è‰²ä¸º `admin`
   - æ£€æŸ¥APIæƒé™è®¾ç½®
   - æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯

### è°ƒè¯•æ–¹æ³•

1. **æŸ¥çœ‹æ•°æ®åº“**

   ```sql
   -- æ£€æŸ¥é‚€è¯·ç 
   SELECT * FROM invitation_codes WHERE code = 'YOUR_CODE';

   -- æ£€æŸ¥ç”¨æˆ·æƒé™
   SELECT * FROM user_permissions WHERE user_id = 'USER_ID';

   -- æ£€æŸ¥ä½¿ç”¨è®°å½•
   SELECT * FROM invitation_uses WHERE code_id = 'CODE_ID';
   ```

2. **æŸ¥çœ‹æ—¥å¿—**
   - æµè§ˆå™¨æ§åˆ¶å°
   - æœåŠ¡å™¨æ—¥å¿—
   - Supabaseæ—¥å¿—

## æ‰©å±•åŠŸèƒ½

### æœªæ¥å¯æ·»åŠ çš„åŠŸèƒ½

1. **æ‰¹é‡é‚€è¯·ç ç”Ÿæˆ**
2. **é‚€è¯·ç æ¨¡æ¿ç³»ç»Ÿ**
3. **é‚€è¯·å…³ç³»é“¾è¿½è¸ª**
4. **é‚€è¯·å¥–åŠ±æœºåˆ¶**
5. **æƒé™è‡ªåŠ¨å‡çº§**
6. **ä½¿ç”¨åˆ†ææŠ¥å‘Š**

## æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸
2. ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®è®¾ç½®
3. ç”¨æˆ·æƒé™æ˜¯å¦è¶³å¤Ÿ
4. ç½‘ç»œè¿æ¥æ˜¯å¦ç¨³å®š

---

**æ³¨æ„**ï¼šæœ¬ç³»ç»Ÿå·²å®Œå…¨é›†æˆåˆ°ç°æœ‰é¡¹ç›®ä¸­ï¼Œæ— éœ€é¢å¤–é…ç½®å³å¯ä½¿ç”¨ã€‚å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‰è¿›è¡Œå……åˆ†æµ‹è¯•ã€‚
