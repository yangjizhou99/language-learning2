# AI发音纠正系统 - 数据库重建指南

> **重要提示**：本操作会删除所有旧的评测数据，请确认后再执行！

---

## 📋 重建原因

### 修复的问题
1. ✅ **格式统一**：拼音统一为带空格格式（"guo 2"）
2. ✅ **序号规整**：unit_id 从1开始连续
3. ✅ **清理重复**：删除 "bao3" 和 "bao 3" 的重复
4. ✅ **生成关联**：自动填充 sentence_units 表
5. ✅ **使用进度表**：启用 user_sentence_progress

### 新增功能
- ✅ **两阶段加载**：先显示25句，点"更多"启用智能推荐
- ✅ **进度追踪**：user_sentence_progress 记录最佳分数和尝试次数
- ✅ **真正别名**：只为 lv↔lü 等真正别名创建映射

---

## 🚀 执行步骤

### 步骤1：备份现有数据（可选）

如果你想保留旧录音作为参考：

```bash
# 备份评测记录
PGPASSWORD=postgres pg_dump -h 127.0.0.1 -p 54340 -U postgres -d postgres \
  -t user_pron_attempts -t user_unit_stats \
  --data-only > backup_pronunciation_$(date +%Y%m%d).sql
```

### 步骤2：删除旧表

在 Supabase Studio SQL Editor 或命令行执行：

```sql
-- 删除旧表（V2迁移会自动执行，这里仅作说明）
DROP TABLE IF EXISTS public.user_sentence_progress CASCADE;
DROP TABLE IF EXISTS public.user_unit_stats CASCADE;
DROP TABLE IF EXISTS public.user_pron_attempts CASCADE;
DROP TABLE IF EXISTS public.sentence_units CASCADE;
DROP TABLE IF EXISTS public.pron_sentences CASCADE;
DROP TABLE IF EXISTS public.unit_alias CASCADE;
DROP TABLE IF EXISTS public.zh_pinyin_units CASCADE;
DROP TABLE IF EXISTS public.unit_catalog CASCADE;
```

### 步骤3：运行V2迁移

```bash
# 方式1：使用 Supabase CLI
supabase db push

# 方式2：在 Supabase Dashboard SQL Editor 中
# 复制 supabase/migrations/20251021000001_create_pronunciation_assessment_v2.sql 的内容
# 粘贴并执行
```

### 步骤4：验证数据

```bash
# 运行诊断脚本
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54341 \
SUPABASE_SERVICE_ROLE_KEY=你的KEY \
node scripts/check-pronunciation-data.js
```

**期望结果**：
```
✅ unit_catalog (zh-CN): ~170 条（基础拼音集合）
✅ pron_sentences (zh-CN): 25 条
✅ sentence_units: ~100 条关联
✅ 所有 symbol 都是带空格格式（如 "guo 2"）
```

### 步骤5：测试功能

1. **刷新页面**
2. **麦克风自检** → 通过
3. **查看句子列表** → 应显示前25句
4. **录制1-2句** → 验证功能正常
5. **点击"练习更多句子"** → 启用智能推荐（如果有sentence_units数据）

---

## 📊 V2 改进对照表

| 项目 | 旧版 | V2版本 |
|------|------|--------|
| **拼音格式** | 混合（guo2 + guo 2） | 统一（guo 2） ✅ |
| **unit_id序号** | 乱序（1, 50, 2000...） | 连续（1, 2, 3...） ✅ |
| **zh_pinyin_units** | 无空格（guo2） | 带空格（guo 2） ✅ |
| **unit_alias** | 大量无意义映射 | 仅真正别名 ✅ |
| **sentence_units** | 空 | 自动生成 ✅ |
| **user_sentence_progress** | 未使用 | 已启用 ✅ |
| **UI加载** | 一次性加载所有 | 25句→更多 ✅ |

---

## 🔧 新增字段说明

### user_sentence_progress 表结构

| 字段 | 类型 | 说明 |
|------|------|------|
| user_id | UUID | 用户ID |
| sentence_id | BIGINT | 句子ID |
| status | TEXT | pending/completed |
| attempts_count | INT | 尝试次数 |
| best_score | NUMERIC | 最佳分数 |
| latest_score | NUMERIC | 最新分数 |
| first_attempt_at | TIMESTAMPTZ | 首次尝试时间 |
| last_attempt_at | TIMESTAMPTZ | 最后尝试时间 |

### 用途
- **快速查询**：哪些句子完成了？
- **进度追踪**：用户完成了 X / 25 句
- **最佳分数**：显示历史最高分
- **统计分析**：平均每句尝试几次？

---

## 🎯 新的用户流程

### 阶段1：基础练习（固定25句）
```
进入页面 → 自检 → 显示25句
    ↓
录制句子（任意顺序）
    ↓
完成部分或全部25句
```

### 阶段2：智能推荐（Set Cover）
```
点击"练习更多句子"
    ↓
系统分析：哪些音节样本<3？
    ↓
推荐句子：优先覆盖薄弱音节
    ↓
继续录制（智能优化）
```

---

## ⚠️ 注意事项

### 1. 数据丢失
- **user_pron_attempts**：所有评测记录将被删除
- **user_unit_stats**：所有统计数据将被删除
- **pronunciation-audio**：音频文件会保留（但记录丢失）

### 2. 用户影响
- 所有用户需要重新录音
- 历史进度清零
- 如有多用户，需要提前通知

### 3. 生产环境
- **不要在生产环境直接执行**
- 应该先在测试环境验证
- 考虑数据迁移脚本

---

## 🔍 迁移后验证清单

- [ ] unit_catalog 有数据（~170条）
- [ ] 所有 symbol 都是带空格格式
- [ ] zh_pinyin_units 与 unit_catalog 对应
- [ ] pron_sentences 有25句
- [ ] sentence_units 有关联数据（~100条）
- [ ] user_sentence_progress 表存在
- [ ] pronunciation-audio bucket 存在
- [ ] RLS 策略已创建

---

## 🐛 如果出现问题

### 问题1：迁移执行失败
```bash
# 查看错误日志
supabase db reset --debug

# 或手动在 SQL Editor 逐段执行
```

### 问题2：sentence_units 仍为空
```
原因：常用字映射可能不全
解决：运行补充脚本或手动添加映射
```

### 问题3：前端报错
```
刷新页面，清除浏览器缓存
检查 API 是否正常返回数据
```

---

## 📞 需要帮助？

如果重建过程中遇到任何问题：
1. 记录错误信息
2. 运行诊断脚本
3. 提供输出结果

---

**创建日期**：2025-10-13  
**迁移版本**：V2 (20251021000001)

