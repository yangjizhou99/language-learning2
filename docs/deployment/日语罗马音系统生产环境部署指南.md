# 日语罗马音发音评测系统生产环境部署指南

## 概述

本指南详细说明如何将日语发音评测系统从IPA音素迁移到训令式罗马字（Kunrei）系统，并部署到生产环境。

## 系统变更

### 主要变更
- **音素系统**：从28个IPA音素 → 104个训令式罗马字音节
- **G2P工具**：从IPA音素提取 → 罗马字音节提取
- **数据迁移**：清理旧数据，重新生成句节关联和用户统计

### 技术特点
- **训令式罗马字**：使用日本官方标准（si/ti/tu而非shi/chi/tsu）
- **按比例分配算法**：将Azure评分按比例分配给罗马音音节
- **完整G2P支持**：处理假名、汉字混合文本，支持拗音、促音、长音

## 部署步骤

### 1. 数据库迁移

运行新的迁移文件：

```bash
# 应用迁移
supabase db push

# 或者手动执行迁移
psql -h your-db-host -U postgres -d your-db-name -f supabase/migrations/20250120000002_update_japanese_to_romaji.sql
```

### 2. 验证迁移结果

检查迁移是否成功：

```sql
-- 验证罗马字音节数量
SELECT COUNT(*) FROM unit_catalog WHERE lang = 'ja-JP';
-- 应该返回 104

-- 查看罗马字音节分类
SELECT * FROM japanese_romaji_view ORDER BY row_category, symbol;
```

### 3. 重新生成数据

运行生产环境部署脚本：

```bash
# 设置环境变量
export NEXT_PUBLIC_SUPABASE_URL="your-supabase-url"
export SUPABASE_SERVICE_ROLE_KEY="your-service-role-key"

# 运行部署脚本
node scripts/production-deploy-japanese-romaji.js
```

### 4. 验证部署结果

检查关键数据：

```sql
-- 检查句节关联
SELECT COUNT(*) FROM sentence_units su
JOIN pron_sentences ps ON su.sentence_id = ps.sentence_id
WHERE ps.lang = 'ja-JP';

-- 检查用户统计
SELECT COUNT(*) FROM user_unit_stats WHERE lang = 'ja-JP';

-- 检查罗马字音节分布
SELECT 
  row_category,
  COUNT(*) as count
FROM japanese_romaji_view 
GROUP BY row_category 
ORDER BY row_category;
```

## 迁移文件说明

### 20250120000002_update_japanese_to_romaji.sql

**功能**：
- 删除现有日文IPA音素数据
- 插入104个训令式罗马字音节
- 创建罗马字音节分类视图
- 清理旧的用户统计和句节关联数据

**包含的音节**：
- 基本音节：46个（あ行、か行、さ行等）
- 浊音：20个（が行、ざ行、だ行、ば行）
- 半浊音：5个（ぱ行）
- 拗音：33个（きゃ、しゃ、ちゃ等）

### 生产环境部署脚本

**scripts/production-deploy-japanese-romaji.js**

**功能**：
- 验证数据库迁移状态
- 重新生成日文句节关联
- 重新处理用户统计数据
- 验证部署结果

## 数据迁移详情

### 删除的数据
- 所有 `lang = 'ja-JP'` 的 `unit_catalog` 记录
- 所有 `lang = 'ja-JP'` 的 `user_unit_stats` 记录
- 所有日文句子的 `sentence_units` 记录
- `ja_phoneme_units` 辅助表
- `japanese_phonemes_view` 视图

### 新增的数据
- 104个罗马字音节在 `unit_catalog` 中
- `japanese_romaji_view` 分类视图
- 重新生成的句节关联数据
- 重新计算的用户统计数据

## 验证清单

### 数据库验证
- [ ] 罗马字音节数量 = 104
- [ ] 罗马字音节分类正确
- [ ] 句节关联数据重新生成
- [ ] 用户统计数据重新计算

### 功能验证
- [ ] 管理界面句节关联功能正常
- [ ] 个人画像页面显示罗马音
- [ ] 雷达图按行分类显示
- [ ] 日语句子生成功能正常

### 性能验证
- [ ] 句节关联查询性能正常
- [ ] 用户统计计算准确
- [ ] 罗马字G2P转换速度正常

## 回滚方案

如果需要回滚到IPA系统：

```sql
-- 1. 删除罗马字数据
DELETE FROM unit_catalog WHERE lang = 'ja-JP';
DELETE FROM user_unit_stats WHERE lang = 'ja-JP';
DELETE FROM sentence_units WHERE sentence_id IN (
  SELECT sentence_id FROM pron_sentences WHERE lang = 'ja-JP'
);

-- 2. 重新运行原始IPA迁移
-- 需要重新执行 20250120000001_create_japanese_phonemes.sql

-- 3. 重新生成数据
-- 运行相应的数据生成脚本
```

## 注意事项

1. **数据备份**：迁移前务必备份数据库
2. **停机时间**：迁移过程需要短暂停机
3. **用户影响**：用户需要重新练习日文发音以生成新的统计数据
4. **兼容性**：确保所有相关API和前端代码已更新

## 监控指标

部署后监控以下指标：

- 日文句节关联数量
- 用户统计数据准确性
- 罗马字G2P转换成功率
- 个人画像页面加载性能

## 故障排除

### 常见问题

1. **迁移失败**：检查数据库权限和连接
2. **数据不完整**：重新运行部署脚本
3. **性能问题**：检查索引和查询优化
4. **显示错误**：验证前端代码更新

### 日志检查

```bash
# 检查应用日志
tail -f logs/application.log

# 检查数据库日志
tail -f logs/postgresql.log

# 检查部署脚本输出
node scripts/production-deploy-japanese-romaji.js
```

## 联系信息

如有问题，请联系：
- 技术负责人：[姓名]
- 邮箱：[email]
- 紧急联系：[电话]

---

**部署日期**：2025年1月20日  
**版本**：v2.0.0  
**状态**：生产就绪
