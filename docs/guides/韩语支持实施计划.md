# 韩语（ko）学习支持三阶段实施计划（A/B/C/D/F）

本文档给出在现有中/日/英学习能力基础上引入韩语学习（不包含韩语 UI 及韩语发音评测）的三阶段落地方案，覆盖：

- A Shadowing（跟读）
- B Cloze-Shadowing（句级挖空）
- C 词汇与解释（词条管理及解释生成，仅沿用现有母语集合，不新增韩语作为解释语言）
- D TTS 试听（Google TTS）
- F 内容生成（主题/小主题下的对话文本生成、合成与入库）

不在本阶段范围（明确排除）：

- UI 界面语言新增韩语（i18n 仅保留 zh/en/ja）
- 韩语发音评测（Pronunciation Assessment，暂不接入 ko-KR）
- Whisper 兜底（仅使用浏览器 Web Speech API）


## 一、总体目标与约束

- 目标：在不影响既有三语能力的前提下，端到端打通韩语学习链路，最小化迁移风险与耦合面。
- 约束：
  - TTS 使用 Google Cloud Text-to-Speech，优先 Neural2，回退 WaveNet/Standard。
  - 实时识别使用浏览器 Web Speech API（`ko-KR`），不引入 Whisper。
  - 题库生成流程沿用“合成对话→上传存储→写入 shadowing_items →（可选）派生 cloze-shadowing”思路；新增“翻译目标语言可选”（仅中文或中英）。
  - DB 迁移允许一次发版，包含新增 `ko` 语言约束、默认权限语言白名单更新。
  - 韩语句子切分 MVP 采用英文标点规则（.?!…）；后续可择机优化。


## 二、阶段划分与里程碑

### 阶段一（MVP 接入，1–2 天）

范围：A/B/C/D/F 基础能力打通；不含 UI 韩语、不含韩语发音评测。

- 代码改动（按文件）：
  1) 语言与映射
  - `src/types/lang.ts`
    - `export type Lang` 增加 `'ko'`
    - `toLocaleCode('ko' → 'ko-KR')`
    - `LANG_LABEL.ko = '韩语'`

  2) Shadowing 过滤与持久化
  - `src/components/shadowing/FilterLanguageSelector.tsx`
    - 语言下拉增加 `ko`
  - `src/lib/shadowingFilterStorage.ts`
    - 类型 `lang?: 'zh' | 'ja' | 'en'` 改为含 `ko`

  3) 练习与识别
  - `src/components/shadowing/SentencePractice.tsx`
    - `type Lang`/Props 增加 `ko`
    - `mapLangToLocale('ko' → 'ko-KR')`
    - `splitSentences`：`ko` 走英文标点切分（.?!…）；保持中文/日文原有逻辑
    - `tokenize`：`ko` 先沿用“非英文逐字”策略（MVP 足够）
  - `src/components/AudioRecorder.tsx`
    - Web Speech `langMap.ko = 'ko-KR'`
  - `src/lib/speechUtils.ts`
    - `speakText` 支持 `ko → 'ko-KR'`

  4) 权限默认
  - `src/lib/user-permissions-server.ts`
    - `defaultPermissions.allowed_languages` 数组添加 `'ko'`

  5) TTS（Google）
  - `src/lib/tts.ts`
    - `DEFAULTS.ko = 'ko-KR-Neural2-A'`（如不可用，运行时回退 WaveNet/Standard）
    - 对话合成使用的角色音色映射若复用此处逻辑，确保含 `ko`（A/B）
  - `src/app/api/tts/voices/route.ts`
    - 无需改动逻辑；`toLocaleCode('ko')` 后可正确列出 `ko-KR` 音色

  6) 对话合成（管理端）
  - `src/app/api/admin/shadowing/synthesize-dialogue/route.ts`
    - `getVoiceForSpeaker`/回退表新增 `ko`（A/B 音色；如 `ko-KR-Neural2-A/B`）

  7) Cloze 生成（管理端）
  - `src/app/api/admin/cloze-shadowing/generate/route.ts`
    - `type Lang` 增加 `'ko'`
    - 提示词中“语言名”增加 `Korean/한국어`

  8) Shadowing 生成（管理端）
  - 新增路由（建议）：`src/app/api/admin/shadowing/generate/route.ts`
    - 功能：基于 `theme_id/subtopic_id/lang=ko/level`，调用 LLM 生成对话文本（含 A:/B: 标签），合成音频，上传存储，写入 `shadowing_items`
    - 新增参数 `translation_targets: string[]`，可选 `['zh']` 或 `['zh','en']`
    - `translations` 字段仅写入所选语言键，默认仅 `zh`

- 数据库迁移（新增一版）
  - 路径建议：`supabase/migrations/20251023XXXXXX_add_korean_support.sql`
  - 目标：
    - 将所有 `CHECK (lang in ('en','ja','zh'))` 扩展为含 `'ko'`（`cloze_shadowing_items`、`alignment_*` 相关表）
    - 更新 `default_user_permissions` 与 `user_permissions` 的 `allowed_languages`，为存量行追加 `'ko'`
    - `NOTIFY pgrst, 'reload schema'` 以刷新 PostgREST 缓存

- 示例迁移草案（简化示意，实际以线上表名为准）：

  ```sql
  -- 1) Cloze-Shadowing: 扩展 lang 检查
  DO $$
  BEGIN
    IF EXISTS (
      SELECT 1 FROM pg_constraint
      WHERE conname = 'cloze_shadowing_items_lang_check'
    ) THEN
      ALTER TABLE public.cloze_shadowing_items
        DROP CONSTRAINT cloze_shadowing_items_lang_check;
    END IF;
    ALTER TABLE public.cloze_shadowing_items
      ADD CONSTRAINT cloze_shadowing_items_lang_check
      CHECK (lang = ANY (ARRAY['en','ja','zh','ko']::text[]));
  END$$;

  -- 2) Alignment 相关表：扩展 lang 检查（如存在）
  DO $$ BEGIN
    IF EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'alignment_materials_lang_check') THEN
      ALTER TABLE public.alignment_materials DROP CONSTRAINT alignment_materials_lang_check;
      ALTER TABLE public.alignment_materials
        ADD CONSTRAINT alignment_materials_lang_check
        CHECK (lang = ANY (ARRAY['en','ja','zh','ko']::text[]));
    END IF;
    IF EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'alignment_subtopics_lang_check') THEN
      ALTER TABLE public.alignment_subtopics DROP CONSTRAINT alignment_subtopics_lang_check;
      ALTER TABLE public.alignment_subtopics
        ADD CONSTRAINT alignment_subtopics_lang_check
        CHECK (lang = ANY (ARRAY['en','ja','zh','ko']::text[]));
    END IF;
    IF EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'alignment_themes_lang_check') THEN
      ALTER TABLE public.alignment_themes DROP CONSTRAINT alignment_themes_lang_check;
      ALTER TABLE public.alignment_themes
        ADD CONSTRAINT alignment_themes_lang_check
        CHECK (lang = ANY (ARRAY['en','ja','zh','ko']::text[]));
    END IF;
  END$$;

  -- 3) 默认权限与存量用户权限追加 'ko'
  UPDATE public.default_user_permissions
  SET allowed_languages = (
    SELECT ARRAY(SELECT DISTINCT unnest(allowed_languages || ARRAY['ko']))
  );

  UPDATE public.user_permissions
  SET allowed_languages = (
    SELECT ARRAY(SELECT DISTINCT unnest(allowed_languages || ARRAY['ko']))
  );

  -- 4) 刷新 PostgREST 缓存
  NOTIFY pgrst, 'reload schema';
  ```

- API 合同（新增/调整）
  - 1) 列音色：`GET /api/tts/voices?lang=ko&kind=Neural2|WaveNet|all`
    - 响应：`VoiceInfo[]`（沿用现有结构）
  - 2) 对话合成：`POST /api/admin/shadowing/synthesize-dialogue`
    - 请求：`{ text: string; lang: 'ko' | ...; speakingRate?: number; pitch?: number; speakerVoices?: Record<string,string> }`
    - 响应：含 `audio_url`, `sentence_timeline`, `applied_speaker_voices`
  - 3) Shadowing 生成（新增建议）：`POST /api/admin/shadowing/generate`
    - 请求体示例：
      ```json
      {
        "lang": "ko",
        "level": 2,
        "theme_id": "<uuid>",
        "subtopic_id": "<uuid>",
        "count": 10,
        "translation_targets": ["zh"]
      }
      ```
    - 响应：`{ ok: true, created: number, items: Array<{id, audio_url, translations, sentence_timeline}> }`
  - 4) Cloze 生成：`POST /api/admin/cloze-shadowing/generate`（已存在）
    - 调用时 `lang='ko'` 即可（依赖已有 ko 的 `shadowing_items` 数据）

- 验收标准
  - `/api/tts/voices?lang=ko` 返回韩语音色
  - 管理端可生成 `lang=ko` 的 Shadowing 项：音频可播放、时间线正确
  - `translations` 仅包含所选语言键（默认仅 `zh`；选中中英时为 `zh/en`）
  - Shadowing/Catalog/Theme/Subtopic API 按 `lang=ko` 过滤正常
  - 实时识别 `ko-KR` 可用（Chrome/Edge 等）

- 风险与回退
  - 若项目下没有 Neural2 韩语音色，运行时回退 WaveNet/Standard；如仍失败，用 `/api/tts/voices?lang=ko` 选择一个存在的 `name`
  - 如需紧急关闭：前端隐藏 `ko`，`default_user_permissions.allowed_languages` 去掉 `'ko'`，不影响既有三语


### 阶段二（体验增强，2–4 天）

- TTS 与声线选择
  - 管理端生成页提供韩语音色下拉（预拉 `/api/tts/voices?lang=ko` 并缓存），支持按角色分别指定音色/速率/音高

- 翻译多目标
  - 生成页增加翻译目标语言多选（默认 `zh`，可叠加 `en`），后台透传 `translation_targets`
  - 详情页翻译切换仅显示已有键，避免空白标签

- 切分与节奏
  - 在可用环境尝试 `Intl.Segmenter('ko', { granularity: 'sentence' })`；兼容性下降时回退英文标点

- 词汇体验
  - 词条页/卡片支持 `speakText(term, 'ko')` 播放

- 日志与指标
  - 对话生成/合成/上传链路加日志，统计失败原因与时延


### 阶段三（扩展与规模化，1–2 周，按需）

- 规模化生成与派生
  - 批量生成 `lang=ko` 的对话，形成稳定的题库；按需派生 Cloze-Shadowing 题目

- 质量与难度
  - 在提示词中加入场景/礼貌级别/词汇表（如 TOPIK 词级）限制，控制长度与可读性

- 形态学（可选）
  - 若需更优的比较/提示，可接入韩语形态分析（Kiwi/Khaiii/KoNLPy 风格）用于 UI 提示（不涉及发音评测）


## 三、实施步骤与发布顺序

1) 开发：完成阶段一代码改动；新增生成路由（或在现有生成流增加 `translation_targets`）
2) 合并：在测试环境部署前端/后端；
3) 迁移：执行 `20251023XXXXXX_add_korean_support.sql`；
4) 校验：
   - `/api/tts/voices?lang=ko` 音色拉取；
   - 管理端生成一批 `ko` 对话，试听、时间线与入库字段（`translations`）正确；
   - Cloze 生成（可选）对 `ko` 正常；
5) 上线：滚动发布，观察日志与告警；必要时回退隐藏 `ko`。


## 四、文件改动清单（阶段一）

- 语言与权限
  - `src/types/lang.ts`
  - `src/components/shadowing/FilterLanguageSelector.tsx`
  - `src/lib/shadowingFilterStorage.ts`
  - `src/lib/user-permissions-server.ts`

- 练习与识别
  - `src/components/shadowing/SentencePractice.tsx`
  - `src/components/AudioRecorder.tsx`
  - `src/lib/speechUtils.ts`

- TTS / 对话合成
  - `src/lib/tts.ts`
  - `src/app/api/tts/voices/route.ts`（无需改动逻辑，依赖 `toLocaleCode`）
  - `src/app/api/admin/shadowing/synthesize-dialogue/route.ts`

- 生成与翻译
  - 新增：`src/app/api/admin/shadowing/generate/route.ts`（建议）
  - 现有：`src/app/api/admin/cloze-shadowing/generate/route.ts`（Lang 加 `ko`）

- 迁移
  - 新增：`supabase/migrations/20251023XXXXXX_add_korean_support.sql`


## 五、API 设计细节

### 1) 管理端生成对话（新增建议）

`POST /api/admin/shadowing/generate`

- 请求体：

```jsonc
{
  "lang": "ko",              // 必填：仅新增 ko；其他语言保持兼容
  "level": 2,                 // 1-5
  "theme_id": "<uuid>",      // 可选：主题
  "subtopic_id": "<uuid>",   // 可选：小主题
  "count": 10,                // 生成条数（1-100）
  "translation_targets": ["zh"] // 可选：['zh'] 或 ['zh','en']；默认仅 ['zh']
}
```

- 响应体：

```jsonc
{
  "ok": true,
  "created": 10,
  "items": [
    {
      "id": "<uuid>",
      "title": "...",
      "audio_url": "https://...",
      "sentence_timeline": [ { "index":0, "text":"A: ...", "start":0.0, "end":2.8, "speaker":"A" } ],
      "translations": { "zh": "..." } // 或 {"zh":"...","en":"..."}
    }
  ]
}
```

- 实现要点：
  - 提示词输出对话文本，强约束行首含 `A:`/`B:`；
  - 使用 `/api/admin/shadowing/synthesize-dialogue` 合成并获取时间线；
  - 仅根据 `translation_targets` 写入 translations 字段；不选英文则不写 `en` 键；
  - 最终插入 `shadowing_items (lang='ko')`，并设置 `status='approved'` 或走草稿→审核流（按现网策略）。

### 2) Cloze 生成（现有）

`POST /api/admin/cloze-shadowing/generate`：

- 仅需在类型与校验处加入 `'ko'`；
- 依赖已有 `shadowing_items(lang='ko')` 作为来源；
- 产物写入 `cloze_shadowing_items(lang='ko')`。


## 六、测试用例与验收脚本

- TTS 列表：
  - `GET /api/tts/voices?lang=ko` 返回 1 条以上韩语音色；缓存命中与 ETag 正常；
  - 选取 `ko-KR-Neural2-A` 或任一可用 name 用于对话合成；

- 对话合成：
  - 输入 3 段以内 `A:`/`B:` 句式文本，能合成音频并返回时间线；合并音频成功；

- 生成入库（管理端）：
  - `translation_targets=['zh']` 时，`translations` 仅含 `zh`；
  - `translation_targets=['zh','en']` 时包含两键；
  - `shadowing_items` 新增行可在前端按 `lang=ko` 过滤到；

- Cloze 生成：
  - `lang=ko` 时生成 1-5 条句级挖空；

- 前端练习：
  - 跟读页切到 `ko`，能按照英文标点分句；
  - 录音选择 `ko-KR`，Web Speech 有实时结果；
  - 词条页面可添加 lang=ko 项并播放发音。


## 七、已知非目标与后续路线

- 不新增 UI 界面语言 `ko`（i18n 仍为 zh/en/ja）
- 不接入韩语发音评测（Azure Pronunciation Assessment for ko-KR）
- 不接入 Whisper 本地/云端兜底
- 后续可根据反馈引入更优句子切分与合成模板、可选形态学支持


## 八、风险评估与回滚策略

- 风险：
  - GCP 项目下韩语 Neural2 声线不可用 → 运行时回退 WaveNet/Standard；
  - Web Speech 在部分 iOS/Safari 场景可用性较弱 → 以“实时识别为辅助”定位；
  - 题库生成质量波动 → 通过模板与审核流缓解。

- 回滚：
  - 前端隐藏 `ko` 选项；
  - `default_user_permissions.allowed_languages` 去除 `'ko'`；
  - 不对既有三语与数据造成破坏性影响；已生成的 ko 数据保留不影响系统运行。


## 九、附录：韩语声线与命名建议

- 推荐优先：`ko-KR-Neural2-A` / `ko-KR-Neural2-B`；
- 若不可用：选择 `/api/tts/voices?lang=ko` 返回中的 `WaveNet` 或 `Standard` 系列；
- 对话合成回退表中为 A/B 分配不同性别或音色，以增强角色区分度。


—— 以上方案将用于指导阶段性改造与验收。如需调整范围（例如引入 UI 韩语或发音评测 ko-KR），可在阶段二/三纳入规划。

