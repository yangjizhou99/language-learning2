# 局域网访问本地 Supabase 数据库配置指南

## 问题描述

iPad 或其他设备在同一 WiFi 下可以访问 Next.js 开发服务器（`http://192.168.31.25:3000`），但无法登录，因为应用无法连接到电脑上 Docker 运行的本地 Supabase 数据库。

## 原因分析

Next.js 应用是在**浏览器端**运行的，当 iPad 访问时：
- 浏览器会执行前端 JavaScript 代码
- 前端代码会根据 `NEXT_PUBLIC_SUPABASE_URL` 连接 Supabase
- 如果 URL 是 `http://localhost:54321` 或 `http://127.0.0.1:54321`
- iPad 会尝试连接**它自己**的 localhost，而不是你电脑的

## 解决方案概览

需要将 Supabase 的访问地址从 `localhost` 改为你电脑的**局域网 IP 地址**。

根据之前的检查，你的电脑局域网 IP 是：**192.168.31.25**

## 详细配置步骤

### 第一步：检查你的局域网 IP（确认是否变化）

```bash
ipconfig
```

找到 **无线局域网适配器 WLAN** 下的 **IPv4 地址**，例如：`192.168.31.25`

### 第二步：配置 Docker 端口绑定

你的 Supabase Docker 容器已经正确绑定到 `0.0.0.0`：
- API Gateway (Kong): `0.0.0.0:54341 → 8000`
- Database: `0.0.0.0:54340 → 5432`
- Studio: `0.0.0.0:54342 → 3000`

✅ 这一步已经完成，无需修改！

### 第三步：配置防火墙允许 Supabase 端口

以**管理员身份**运行 PowerShell，添加防火墙规则：

```powershell
# 允许 Supabase API Gateway (Kong)
netsh advfirewall firewall add rule name="Supabase API Gateway" dir=in action=allow protocol=TCP localport=54341

# 允许 Supabase Database (可选，API 访问通过 Kong)
netsh advfirewall firewall add rule name="Supabase Database" dir=in action=allow protocol=TCP localport=54340

# 允许 Supabase Studio (可选，用于管理面板)
netsh advfirewall firewall add rule name="Supabase Studio" dir=in action=allow protocol=TCP localport=54342
```

### 第四步：创建 .env.local 文件

在项目根目录创建 `.env.local` 文件（如果已存在则修改）：

```bash
# 方法1：复制模板
cp env.minimal .env.local

# 方法2：手动创建
touch .env.local
```

### 第五步：配置环境变量

编辑 `.env.local` 文件，**关键配置如下**：

```env
# ==========================================
# Supabase 本地开发配置（局域网访问）
# ==========================================

# 【重要】将 localhost 改为你的局域网 IP
NEXT_PUBLIC_SUPABASE_URL=http://192.168.31.25:54341
NEXT_PUBLIC_SUPABASE_ANON_KEY=你的_anon_key

# Service Role Key（后端使用）
SUPABASE_SERVICE_ROLE_KEY=你的_service_role_key

# ==========================================
# 获取 Supabase Keys
# ==========================================
# 方法1：查看本地 Supabase 启动日志
# 方法2：访问 http://localhost:54342 (Supabase Studio)
#        进入 Settings → API，查看 anon key 和 service_role key
# ==========================================

# 应用配置
NEXT_PUBLIC_SITE_URL=http://192.168.31.25:3000
NEXT_PUBLIC_SITE_NAME=Language Learning App

# AI 提供商（至少配置一个）
OPENROUTER_API_KEY=sk-or-v1-your-key
# 或者
# DEEPSEEK_API_KEY=sk-your-key
# 或者
# OPENAI_API_KEY=sk-your-key

# Google Cloud TTS（如果使用）
# GOOGLE_APPLICATION_CREDENTIALS=./service-account.json

# 数据库直连配置（仅用于数据同步脚本，不是 Next.js 使用）
LOCAL_DB_URL=postgres://postgres:postgres@127.0.0.1:54340/postgres
PROD_DB_URL=postgresql://postgres:[密码]@db.your-project.supabase.co:5432/postgres
```

### 第六步：获取 Supabase Keys

**方法 1：从 Supabase Studio 获取**

1. 在**电脑**上访问：`http://localhost:54342`
2. 进入 **Settings** → **API**
3. 复制：
   - **anon key** (公开密钥)
   - **service_role key** (服务端密钥)

**方法 2：从 Supabase 启动日志查看**

```bash
supabase status
```

输出示例：
```
API URL: http://127.0.0.1:54341
...
anon key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
service_role key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 第七步：重启 Next.js 开发服务器

停止服务器（Ctrl+C），然后重新启动：

```bash
npm run dev
```

确认输出显示：
```
▲ Next.js 15.4.6 (Turbopack)
- Local:        http://localhost:3000
- Network:      http://0.0.0.0:3000
- Environments: .env.local   ← 确认加载了环境变量
```

### 第八步：测试访问

**在 iPad 上：**

1. 打开浏览器
2. 访问：`http://192.168.31.25:3000`
3. 尝试登录或注册
4. 应该可以正常连接数据库了！ 🎉

## 验证配置

### 检查 Supabase 连接

在浏览器开发者工具中（F12），查看 Network 标签：

- ✅ 应该看到请求发送到 `http://192.168.31.25:54341/...`
- ❌ 不应该看到 `localhost` 或 `127.0.0.1`

### 检查 Docker 容器状态

```bash
docker ps
```

确认以下容器在运行：
- `supabase_kong_language-learning2` (API Gateway)
- `supabase_db_language-learning2` (Database)
- `supabase_auth_language-learning2` (Auth)

## 常见问题排查

### ❌ 问题 1：iPad 仍然无法连接数据库

**可能原因：**
1. 防火墙未放行 54341 端口
2. 环境变量配置错误
3. Supabase Keys 不正确

**解决方法：**

```bash
# 1. 检查防火墙规则
netsh advfirewall firewall show rule name="Supabase API Gateway"

# 2. 检查环境变量是否加载
# 在电脑浏览器访问 http://localhost:3000
# 打开开发者工具 Console，输入：
console.log(process.env.NEXT_PUBLIC_SUPABASE_URL)
# 应该显示：http://192.168.31.25:54341

# 3. 测试 Supabase API 是否可访问
# 在 iPad 浏览器访问：
# http://192.168.31.25:54341/
# 应该返回 API 信息
```

### ❌ 问题 2：CORS 跨域错误

**现象：** 浏览器控制台显示 CORS 错误

**解决方法：** 修改 Supabase Kong 配置（已自动配置，通常不需要修改）

如果需要手动配置，编辑 `supabase/config.toml`：

```toml
[api]
enabled = true
port = 54341
# 添加额外的 CORS 配置
extra_search_path = ["public", "extensions"]
```

### ❌ 问题 3：认证失败

**现象：** 登录时提示 "Invalid credentials"

**原因：** 本地 Supabase 数据库是空的，没有用户数据

**解决方法：**

1. **重新注册账号**（推荐）
2. **同步云端数据到本地**（如果有云端数据库）
   ```bash
   npm run db:pull
   ```

### ❌ 问题 4：IP 地址变化后无法访问

**原因：** 路由器重新分配了 IP 地址

**解决方法：**

1. 用 `ipconfig` 查看新的 IP 地址
2. 修改 `.env.local` 中的 `NEXT_PUBLIC_SUPABASE_URL`
3. 重启 Next.js 开发服务器

**永久解决：** 在路由器设置中为电脑分配固定 IP

### ❌ 问题 5：生产环境配置

**注意：** 以上配置**仅用于本地开发**！

生产环境应该使用：
```env
# 生产环境（Vercel 部署）
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_production_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_production_service_role_key
```

## 完整配置示例

**`.env.local` 完整示例（本地开发 + 局域网访问）：**

```env
# ==========================================
# Supabase 本地开发配置（局域网访问）
# ==========================================
# 将 192.168.31.25 替换为你的实际局域网 IP
NEXT_PUBLIC_SUPABASE_URL=http://192.168.31.25:54341
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU

# 应用配置
NEXT_PUBLIC_SITE_URL=http://192.168.31.25:3000
NEXT_PUBLIC_SITE_NAME=Language Learning App

# AI 提供商
OPENROUTER_API_KEY=sk-or-v1-your-openrouter-key
DEEPSEEK_API_KEY=sk-your-deepseek-key

# 数据库直连（仅用于同步脚本）
LOCAL_DB_URL=postgres://postgres:postgres@127.0.0.1:54340/postgres
PROD_DB_URL=postgresql://postgres:your-password@db.project.supabase.co:5432/postgres
```

**注意：** 上面的示例 keys 是 Supabase 本地开发的默认密钥，如果你自定义了密钥，请使用你自己的。

## 环境切换最佳实践

如果你需要在不同环境之间切换（本机开发 vs 局域网访问），可以创建多个环境变量文件：

### 方案 1：使用不同的配置文件

```bash
# 本机开发配置
.env.local

# 局域网访问配置
.env.network
```

**切换方法：**
```bash
# 使用局域网配置
cp .env.network .env.local

# 恢复本机配置
cp .env.local.backup .env.local
```

### 方案 2：使用环境变量覆盖

```bash
# package.json
{
  "scripts": {
    "dev": "next dev --turbopack -H 0.0.0.0",
    "dev:network": "NEXT_PUBLIC_SUPABASE_URL=http://192.168.31.25:54341 npm run dev"
  }
}
```

### 方案 3：动态检测（推荐）

创建 `lib/supabase-config.ts`：

```typescript
// 自动检测运行环境
const isNetworkAccess = typeof window !== 'undefined' && 
  !window.location.hostname.includes('localhost');

export const supabaseUrl = isNetworkAccess
  ? process.env.NEXT_PUBLIC_SUPABASE_URL_NETWORK || process.env.NEXT_PUBLIC_SUPABASE_URL
  : process.env.NEXT_PUBLIC_SUPABASE_URL;
```

然后在 `.env.local` 中：
```env
# 本地访问
NEXT_PUBLIC_SUPABASE_URL=http://localhost:54341

# 网络访问
NEXT_PUBLIC_SUPABASE_URL_NETWORK=http://192.168.31.25:54341
```

## 安全建议

⚠️ **重要提醒：**

1. **不要在生产环境使用 HTTP**
   - 生产环境必须使用 HTTPS
   - Supabase 云端项目自带 HTTPS

2. **不要将 .env.local 提交到 Git**
   - 已在 `.gitignore` 中排除
   - 确保不包含敏感信息

3. **不要在公共 WiFi 中开启局域网访问**
   - 仅在可信任的网络使用
   - 完成开发后关闭不必要的防火墙规则

4. **service_role_key 只在服务端使用**
   - 不要在客户端代码中暴露
   - 只在 API 路由中使用

## 快速检查脚本

创建 `check-supabase.bat`：

```batch
@echo off
echo ========================================
echo Supabase 局域网访问检查工具
echo ========================================
echo.

echo [1] 检查局域网 IP
ipconfig | findstr "IPv4"
echo.

echo [2] 检查 Supabase 容器状态
docker ps | findstr "supabase"
echo.

echo [3] 检查防火墙规则
netsh advfirewall firewall show rule name="Supabase API Gateway"
echo.

echo [4] 测试 Supabase API (在浏览器访问)
echo http://192.168.31.25:54341/
echo.

pause
```

## 总结

**核心配置清单：**

- ✅ Next.js 监听 `0.0.0.0`（已完成）
- ✅ Docker 绑定 `0.0.0.0`（已完成）
- ✅ 配置防火墙放行 54341 端口
- ✅ 创建 `.env.local` 文件
- ✅ 设置 `NEXT_PUBLIC_SUPABASE_URL=http://192.168.31.25:54341`
- ✅ 设置正确的 `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- ✅ 重启开发服务器

**访问地址：**
- iPad 访问应用：`http://192.168.31.25:3000`
- iPad 访问 API：`http://192.168.31.25:54341` （自动）
- 电脑访问 Studio：`http://localhost:54342`

---

最后更新：2025年10月11日

