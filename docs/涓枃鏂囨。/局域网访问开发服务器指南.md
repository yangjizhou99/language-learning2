# 局域网访问 Next.js 开发服务器指南

## 问题描述

在同一 WiFi 网络下，其他设备（如 iPad、手机）无法访问本机运行的 Next.js 开发服务器。

## 原因分析

Next.js 开发服务器默认只监听 `localhost` (127.0.0.1)，只能本机访问。其他设备需要通过局域网 IP 访问，因此需要：
1. 让服务器监听所有网络接口 (`0.0.0.0`)
2. 获取本机的正确局域网 IP 地址
3. 配置防火墙允许访问

## 解决步骤

### 1. 修改 Next.js 开发命令

**修改 `package.json` 文件：**

```json
{
  "scripts": {
    "dev": "next dev --turbopack -H 0.0.0.0"
  }
}
```

**参数说明：**
- `-H 0.0.0.0` 或 `--hostname 0.0.0.0`：监听所有网络接口
- 如果不使用 Turbopack，可以用：`next dev -H 0.0.0.0`

### 2. 获取本机局域网 IP 地址

**Windows 系统：**

```bash
ipconfig
```

**查找对应的网络适配器：**
- **无线网络**：查找 `无线局域网适配器 WLAN` 下的 `IPv4 地址`
- **有线网络**：查找 `以太网适配器 以太网` 下的 `IPv4 地址`

**正确的 IP 地址格式：**
- ✅ `192.168.x.x` （最常见）
- ✅ `10.x.x.x`
- ❌ `169.254.x.x` （通常是 VPN 或自动配置地址，不是实际局域网 IP）
- ❌ `127.0.0.1` （本机回环地址）

**示例输出：**
```
无线局域网适配器 WLAN:
   IPv4 地址 . . . . . . . . . . . . : 192.168.31.25  ← 使用这个
   子网掩码  . . . . . . . . . . . . : 255.255.255.0
   默认网关. . . . . . . . . . . . . : 192.168.31.1
```

### 3. 配置 Windows 防火墙

**方法 A - 使用命令行（推荐）：**

以**管理员身份**运行 PowerShell：

```powershell
netsh advfirewall firewall add rule name="Next.js Dev Server" dir=in action=allow protocol=TCP localport=3000
```

**方法 B - 通过图形界面：**

1. 打开 **Windows Defender 防火墙**
2. 点击左侧 **高级设置**
3. 选择 **入站规则** → 右键 **新建规则**
4. 规则类型：选择 **端口** → 下一步
5. 协议：选择 **TCP**，特定本地端口：输入 **3000**
6. 操作：选择 **允许连接**
7. 配置文件：全选（域、专用、公用）
8. 名称：输入 `Next.js Dev Server`
9. 完成

### 4. 启动服务器并访问

**启动开发服务器：**

```bash
npm run dev
```

**确认输出显示：**
```
▲ Next.js 15.4.6 (Turbopack)
- Local:        http://localhost:3000
- Network:      http://0.0.0.0:3000      ← 看到这个说明配置成功
- Environments: .env.local
```

**在其他设备上访问：**

打开浏览器，输入：
```
http://你的局域网IP:3000
```

例如：`http://192.168.31.25:3000`

## 常见问题排查

### ❌ 问题 1：服务器启动了但其他设备无法访问

**检查清单：**

1. **确认两台设备在同一 WiFi 网络**
   ```bash
   # 在电脑上检查 IP 和网关
   ipconfig
   
   # 在手机/iPad 上检查 IP 和网关
   # 设置 → WiFi → 点击已连接的网络 → 查看 IP 地址
   # 确保网关（路由器地址）相同
   ```

2. **检查防火墙规则**
   ```powershell
   # 查看是否存在规则
   netsh advfirewall firewall show rule name="Next.js Dev Server"
   
   # 如果没有，重新添加
   netsh advfirewall firewall add rule name="Next.js Dev Server" dir=in action=allow protocol=TCP localport=3000
   ```

3. **检查路由器 AP 隔离**
   - 某些路由器开启了 AP 隔离功能，会阻止设备间通信
   - 登录路由器管理界面，查找 "AP 隔离"、"客户端隔离" 等选项，确保已关闭

4. **检查 VPN 是否干扰**
   - 如果电脑开启了 VPN，可能影响局域网访问
   - 尝试暂时断开 VPN 测试

### ❌ 问题 2：IP 地址经常变化

**解决方案：在路由器中设置静态 IP**

1. 登录路由器管理界面（通常是 `192.168.1.1` 或 `192.168.31.1`）
2. 找到 **DHCP 设置** 或 **静态 IP 分配**
3. 根据电脑的 MAC 地址分配固定 IP
4. 保存并重启路由器

**或者在 Windows 中手动设置静态 IP：**

1. 设置 → 网络和 Internet → WiFi → 属性
2. IP 设置 → 编辑 → 手动
3. 输入固定 IP、子网掩码、网关、DNS
4. 保存

### ❌ 问题 3：端口 3000 被占用

**检查端口占用：**

```bash
netstat -ano | findstr :3000
```

**更改端口：**

```bash
# 使用其他端口启动
npm run dev -- -p 3001
```

或修改 `package.json`：
```json
{
  "scripts": {
    "dev": "next dev --turbopack -H 0.0.0.0 -p 3001"
  }
}
```

记得在防火墙中也添加新端口的规则。

### ❌ 问题 4：使用了错误的 IP 地址

**识别正确的 IP：**

| IP 类型 | 范围 | 是否可用 | 说明 |
|---------|------|----------|------|
| 局域网 IP | 192.168.x.x | ✅ | 最常用，优先使用 |
| 局域网 IP | 10.x.x.x | ✅ | 企业网络常用 |
| 局域网 IP | 172.16.x.x - 172.31.x.x | ✅ | 部分路由器使用 |
| 自动配置地址 | 169.254.x.x | ❌ | 通常是 VPN 虚拟网卡 |
| 本地回环 | 127.0.0.1 | ❌ | 只能本机访问 |
| Docker/WSL | 172.x.x.x | ❌ | 虚拟网络地址 |

**如果有多个网卡（如 Tailscale、VMware、WSL）：**

```bash
ipconfig
```

找到 **无线局域网适配器 WLAN** 或 **以太网适配器** 的 IPv4 地址。

## 快速检查命令

**一键检查脚本：**

创建 `check-network.bat` 文件：

```batch
@echo off
echo ========================================
echo 局域网访问检查工具
echo ========================================
echo.

echo [1] 检查网络配置
ipconfig | findstr /C:"无线局域网" /C:"IPv4" /C:"默认网关"
echo.

echo [2] 检查端口 3000 占用情况
netstat -ano | findstr :3000
echo.

echo [3] 检查防火墙规则
netsh advfirewall firewall show rule name="Next.js Dev Server"
echo.

pause
```

双击运行即可查看所有信息。

## 其他开发服务器

这个方法也适用于其他开发服务器：

**Vite：**
```json
{
  "scripts": {
    "dev": "vite --host 0.0.0.0"
  }
}
```

**React (Create React App)：**
```json
{
  "scripts": {
    "start": "HOST=0.0.0.0 react-scripts start"
  }
}
```

**Vue CLI：**
```json
{
  "scripts": {
    "serve": "vue-cli-service serve --host 0.0.0.0"
  }
}
```

## 安全建议

⚠️ **注意事项：**

1. **只在可信任的局域网中使用**（如家庭或办公室 WiFi）
2. **不要在公共 WiFi 中开启**，以免暴露开发服务器
3. **生产环境不使用 `0.0.0.0`**，应该使用正确的域名和 HTTPS
4. **开发完成后关闭不必要的防火墙规则**

## 总结

**核心步骤：**
1. ✅ 修改 `package.json` 添加 `-H 0.0.0.0`
2. ✅ 用 `ipconfig` 找到正确的局域网 IP（192.168.x.x）
3. ✅ 配置防火墙允许端口 3000
4. ✅ 在其他设备访问 `http://局域网IP:3000`

**记住：**
- 使用 `192.168.x.x` 开头的 IP
- 不要使用 `169.254.x.x` (VPN/虚拟网卡)
- 确保在同一 WiFi 网络
- 防火墙要放行 3000 端口

---

最后更新：2025年10月11日

