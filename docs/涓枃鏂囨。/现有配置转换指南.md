# 现有配置转换为局域网访问指南

## 问题说明

你已经有一个配置好的 `.env.local` 文件，包含所有 API keys 和数据库配置。现在只需要修改 URL 地址，让 iPad 也能访问。

## 需要修改的内容

只需要修改 2 个配置项：

```env
# 修改前（只能本机访问）
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54341
NEXT_PUBLIC_SITE_URL=http://localhost:3001

# 修改后（电脑和 iPad 都能访问）
NEXT_PUBLIC_SUPABASE_URL=http://192.168.31.25:54341
NEXT_PUBLIC_SITE_URL=http://192.168.31.25:3000
```

**其他配置（API keys、TTS 配置等）完全不变！**

## 快速操作（推荐）

### 方法 1：自动转换脚本

**步骤 1：运行转换脚本**
```bash
# 双击运行
update-to-network.bat
```

这个脚本会：
- ✅ 自动获取你的局域网 IP
- ✅ 备份原配置到 `.env.local.backup`
- ✅ 只修改 URL，保留所有其他配置
- ✅ 配置防火墙规则

**步骤 2：重启开发服务器**
```bash
# 停止当前服务器（Ctrl+C）
# 重新启动
npm run dev
```

完成！🎉

### 方法 2：手动修改

打开 `.env.local` 文件，找到以下两行：

```env
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54341
NEXT_PUBLIC_SITE_URL=http://localhost:3001
```

修改为：

```env
NEXT_PUBLIC_SUPABASE_URL=http://192.168.31.25:54341
NEXT_PUBLIC_SITE_URL=http://192.168.31.25:3000
```

**注意：** 如果你的电脑 IP 不是 `192.168.31.25`，用 `ipconfig` 查看实际 IP。

## 如何恢复

如果需要恢复为仅本机访问：

```bash
# 双击运行
restore-to-localhost.bat
```

或手动恢复：
```bash
copy .env.local.backup .env.local
```

## 完整操作流程

### 1. 转换配置

```bash
# 运行转换脚本
update-to-network.bat

# 或手动修改 .env.local
# 将 127.0.0.1 → 192.168.31.25
# 将 localhost → 192.168.31.25
```

### 2. 确认防火墙规则

脚本会自动添加，如果失败，手动运行：

```powershell
# 管理员权限运行
netsh advfirewall firewall add rule name="Next.js Dev Server" dir=in action=allow protocol=TCP localport=3000
netsh advfirewall firewall add rule name="Supabase API Gateway" dir=in action=allow protocol=TCP localport=54341
```

### 3. 重启服务器

```bash
# 停止当前服务器
Ctrl+C

# 重新启动
npm run dev
```

### 4. 测试访问

**在电脑上：**
- 访问：`http://192.168.31.25:3000`
- 应该能正常登录和使用

**在 iPad 上：**
- 确保连接同一 WiFi
- 访问：`http://192.168.31.25:3000`
- 使用相同账号登录

## 验证配置

### 检查配置是否正确

```bash
# 方法1：查看配置文件
cat .env.local | findstr NEXT_PUBLIC_SUPABASE_URL

# 应该显示：
# NEXT_PUBLIC_SUPABASE_URL=http://192.168.31.25:54341
```

### 检查防火墙规则

```bash
netsh advfirewall firewall show rule name="Next.js Dev Server"
netsh advfirewall firewall show rule name="Supabase API Gateway"
```

### 检查 Supabase 服务

```bash
docker ps | findstr supabase_kong
# 应该显示容器在运行
```

## 常见问题

### ❌ 修改后电脑无法访问

**原因：** 电脑也需要使用局域网 IP 访问

**解决：**
- ✅ 访问 `http://192.168.31.25:3000`（推荐）
- ✅ 也可以访问 `http://localhost:3000`（也能用！）

### ❌ iPad 仍然无法访问

**检查清单：**

1. **确认两台设备在同一 WiFi**
   ```
   电脑和 iPad 的网关（路由器地址）应该相同
   ```

2. **确认 IP 地址正确**
   ```bash
   ipconfig
   # 查看无线局域网适配器 IPv4 地址
   ```

3. **确认防火墙规则**
   ```bash
   netsh advfirewall firewall show rule name="Supabase API Gateway"
   ```

4. **确认服务器已重启**
   - 修改 `.env.local` 后必须重启开发服务器

### ❌ 数据库连接失败

**检查 Supabase 容器：**

```bash
docker ps
```

确保这些容器在运行：
- `supabase_kong_language-learning2` (API Gateway)
- `supabase_db_language-learning2` (Database)

如果没有运行：
```bash
supabase start
```

### ❌ IP 地址变了

**现象：** 路由器重新分配了 IP

**解决：**

1. 查看新 IP：
   ```bash
   ipconfig
   ```

2. 重新运行转换脚本：
   ```bash
   update-to-network.bat
   ```

3. 或手动修改 `.env.local` 中的 IP

## 配置对比

### 修改前（localhost 模式）

```env
# 只能电脑访问
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54341
NEXT_PUBLIC_SITE_URL=http://localhost:3001

# 访问方式
# 电脑: http://localhost:3001 ✅
# iPad: 无法访问 ❌
```

### 修改后（局域网模式）

```env
# 电脑和 iPad 都能访问
NEXT_PUBLIC_SUPABASE_URL=http://192.168.31.25:54341
NEXT_PUBLIC_SITE_URL=http://192.168.31.25:3000

# 访问方式
# 电脑: http://192.168.31.25:3000 ✅
# 电脑: http://localhost:3000 ✅（也能用！）
# iPad: http://192.168.31.25:3000 ✅
```

## 完整的 .env.local 示例（修改后）

```env
# ===========================================
# 本地 Supabase 配置（局域网访问）
# ===========================================
NEXT_PUBLIC_SUPABASE_URL=http://192.168.31.25:54341  # ← 修改这里
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...  # 保持不变
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...  # 保持不变

LOCAL_DB_URL=postgres://postgres:postgres@127.0.0.1:54340/postgres  # 保持不变

# ===========================================
# 应用基础配置
# ===========================================
NEXT_PUBLIC_SITE_URL=http://192.168.31.25:3000  # ← 修改这里
NEXT_PUBLIC_SITE_NAME=Language Learning App (Local Dev)  # 保持不变

# AI 提供商配置（保持不变）
OPENROUTER_API_KEY=sk-or-v1-你的key  # 保持不变
DEEPSEEK_API_KEY=sk-你的key  # 保持不变

# TTS 配置（保持不变）
XUNFEI_APP_ID=你的配置  # 保持不变
# ... 其他配置都保持不变
```

## 工具脚本说明

### update-to-network.bat
- 将配置转换为局域网访问模式
- 自动备份原配置
- 添加防火墙规则

### restore-to-localhost.bat
- 恢复为仅本机访问模式
- 从备份恢复配置

### check-network-setup.bat
- 检查当前配置状态
- 查看 IP、容器、防火墙等

## 数据库说明

你的数据库数据**不会丢失**！

- ✅ 数据库文件保存在 Docker 卷中
- ✅ 只是修改了访问地址
- ✅ 所有数据、用户、内容都还在
- ✅ 修改配置不影响数据

## 下一步

修改完成后：

1. **测试电脑访问**
   - 访问 `http://192.168.31.25:3000`
   - 登录你的账号
   - 确认数据都在

2. **测试 iPad 访问**
   - 访问 `http://192.168.31.25:3000`
   - 登录相同账号
   - 验证数据同步

3. **开始多设备测试**
   - 参考 `多设备测试指南.md`
   - 享受多设备开发体验！

## 总结

✅ **核心修改：** 只修改 2 个 URL  
✅ **其他配置：** 完全保留（API keys、TTS 等）  
✅ **数据库：** 不受影响，数据都在  
✅ **可恢复：** 随时恢复为 localhost 模式  
✅ **多设备：** 电脑和 iPad 同时测试  

---

最后更新：2025年10月11日

