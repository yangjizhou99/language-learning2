# 多设备同时测试配置指南

## 目标

让电脑和 iPad 同时访问本地开发环境进行测试。

## 核心原理

使用**局域网 IP 地址**作为统一的访问地址，这样：
- ✅ 电脑访问：`http://192.168.31.25:3000`
- ✅ iPad 访问：`http://192.168.31.25:3000`
- ✅ 都连接同一个 Supabase 数据库

## 快速开始（3 步）

### 步骤 1：运行自动配置脚本

双击运行：
```
setup-network-access.bat
```

这个脚本会自动：
1. 复制环境变量配置
2. 添加防火墙规则
3. 检查 Supabase 服务
4. 获取你的局域网 IP

### 步骤 2：填入 API Key

编辑 `.env.local` 文件，填入你的实际 API Key：

```env
# 至少配置一个
OPENROUTER_API_KEY=sk-or-v1-你的真实key
# 或
DEEPSEEK_API_KEY=sk-你的真实key
# 或
OPENAI_API_KEY=sk-你的真实key
```

### 步骤 3：启动开发服务器

```bash
npm run dev
```

完成！现在可以在电脑和 iPad 上同时访问了。

## 详细配置步骤（手动）

如果自动脚本无法运行，可以手动配置：

### 1. 创建 .env.local 文件

复制模板：
```bash
copy env.network-template .env.local
```

或手动创建 `.env.local`，内容如下：

```env
# Supabase 配置（使用局域网 IP）
NEXT_PUBLIC_SUPABASE_URL=http://192.168.31.25:54341
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU

# 应用配置
NEXT_PUBLIC_SITE_URL=http://192.168.31.25:3000
NEXT_PUBLIC_SITE_NAME=Language Learning App

# AI Key（填入真实 key）
OPENROUTER_API_KEY=你的key
```

### 2. 配置防火墙

以管理员身份运行 PowerShell：

```powershell
# Next.js 服务器
netsh advfirewall firewall add rule name="Next.js Dev Server" dir=in action=allow protocol=TCP localport=3000

# Supabase API
netsh advfirewall firewall add rule name="Supabase API Gateway" dir=in action=allow protocol=TCP localport=54341

# Supabase Studio（可选）
netsh advfirewall firewall add rule name="Supabase Studio" dir=in action=allow protocol=TCP localport=54342
```

### 3. 确认 Supabase 运行

```bash
docker ps
```

查看以下容器是否运行：
- `supabase_kong_language-learning2`
- `supabase_db_language-learning2`

如果没有运行：
```bash
supabase start
```

### 4. 启动 Next.js

```bash
npm run dev
```

## 访问地址

### 电脑访问

浏览器打开：`http://192.168.31.25:3000`

**注意：** 
- ✅ 可以用局域网IP：`http://192.168.31.25:3000`
- ✅ 也可以用 localhost：`http://localhost:3000`（两者都能用！）

### iPad 访问

1. 确保 iPad 连接到**同一个 WiFi**
2. 打开 Safari 或 Chrome
3. 访问：`http://192.168.31.25:3000`

### Supabase 管理面板

在电脑上访问：`http://localhost:54342`

## 验证配置

运行检查脚本：
```bash
check-network-setup.bat
```

这会检查：
- 局域网 IP 地址
- Next.js 配置
- Supabase 容器状态
- 防火墙规则
- 环境变量配置

## 测试步骤

### 1. 测试基本访问

**在电脑上：**
1. 打开 `http://192.168.31.25:3000`
2. 应该能看到应用界面

**在 iPad 上：**
1. 打开 `http://192.168.31.25:3000`
2. 应该看到相同的界面

### 2. 测试数据库连接

**在电脑上：**
1. 尝试注册一个新账号
2. 注册成功后登录

**在 iPad 上：**
1. 使用相同的账号登录
2. 应该能成功登录（证明共享同一个数据库）

### 3. 测试数据同步

**在电脑上：**
1. 创建一些学习内容
2. 刷新页面，数据仍然存在

**在 iPad 上：**
1. 登录相同账号
2. 应该能看到在电脑上创建的内容

## 常见问题

### ❌ iPad 无法访问

**检查清单：**

1. **两台设备在同一 WiFi？**
   ```
   电脑：设置 → 网络 → 查看网关
   iPad：设置 → WiFi → 点击网络 → 查看路由器
   
   确保路由器地址相同（如 192.168.31.1）
   ```

2. **IP 地址正确？**
   ```bash
   # 在电脑上运行
   ipconfig
   
   # 找到 "无线局域网适配器 WLAN" 下的 IPv4 地址
   # 确认是否还是 192.168.31.25
   ```

3. **防火墙规则生效？**
   ```bash
   netsh advfirewall firewall show rule name="Next.js Dev Server"
   ```

### ❌ 电脑无法登录

**可能原因：** 本地数据库没有用户数据

**解决方法：** 重新注册账号

1. 访问 `http://192.168.31.25:3000`
2. 点击注册
3. 创建新账号

### ❌ API 调用失败

**检查 Supabase URL：**

在浏览器按 F12，Console 中输入：
```javascript
console.log(process.env.NEXT_PUBLIC_SUPABASE_URL)
```

应该显示：`http://192.168.31.25:54341`

如果不是，说明：
1. `.env.local` 配置错误
2. 需要重启开发服务器

### ❌ IP 地址变了

**现象：** 路由器重新分配了 IP

**解决：**

1. 查看新 IP：
   ```bash
   ipconfig
   ```

2. 更新 `.env.local`：
   ```env
   # 将 192.168.31.25 替换为新 IP
   NEXT_PUBLIC_SUPABASE_URL=http://新IP:54341
   NEXT_PUBLIC_SITE_URL=http://新IP:3000
   ```

3. 重启服务器：
   ```bash
   npm run dev
   ```

**永久解决：** 在路由器中设置静态 IP

## 性能优化

### 1. 使用 Turbopack（已配置）

`package.json` 中已配置：
```json
{
  "scripts": {
    "dev": "next dev --turbopack -H 0.0.0.0"
  }
}
```

### 2. 局域网速度

- WiFi 5 (802.11ac): 最高 1.3 Gbps
- WiFi 6 (802.11ax): 最高 9.6 Gbps

确保路由器和设备都支持较新的 WiFi 标准。

### 3. 减少网络延迟

- 将路由器放置在电脑和 iPad 之间
- 避免墙壁和金属物体阻挡信号
- 使用 5GHz WiFi 频段（如果支持）

## 开发技巧

### 1. 实时同步测试

**场景：** 在电脑上修改代码，在 iPad 上实时查看效果

1. 电脑上修改代码并保存
2. Next.js 自动热重载
3. iPad 浏览器会自动刷新（需要手动刷新一次）

### 2. 调试技巧

**在 iPad 上调试：**

1. iPad：设置 → Safari → 高级 → 启用"网页检查器"
2. 电脑：Mac 上用 Safari，Windows 上用远程调试工具
3. 或者使用 [eruda](https://github.com/liriliri/eruda) 移动端调试工具

**添加 eruda 调试器（可选）：**

在 `src/app/layout.tsx` 中添加：
```tsx
{process.env.NODE_ENV === 'development' && (
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init()</script>
)}
```

### 3. 多设备状态同步

使用 Supabase Realtime 实现跨设备实时同步：

```typescript
// 示例：监听数据变化
const subscription = supabase
  .channel('study_cards')
  .on('postgres_changes', 
    { event: '*', schema: 'public', table: 'study_cards' },
    (payload) => {
      console.log('数据变化:', payload)
      // 更新 UI
    }
  )
  .subscribe()
```

## 安全提示

⚠️ **开发环境配置，不要用于生产！**

1. **仅在可信任的 WiFi 使用**
   - 家庭网络 ✅
   - 办公室网络 ✅
   - 公共 WiFi ❌

2. **不要在外网访问**
   - 不要开启路由器端口转发
   - 不要使用 ngrok 等内网穿透工具暴露到公网

3. **敏感数据保护**
   - `.env.local` 已在 `.gitignore` 中
   - 不要提交到 Git 仓库
   - 不要截图分享包含 API Key 的内容

4. **测试完成后**
   - 关闭不必要的防火墙规则
   - 停止 Docker 容器节省资源

## 故障恢复

### 重置环境

如果配置混乱，重新开始：

```bash
# 1. 停止所有服务
npm stop
supabase stop

# 2. 删除配置
del .env.local

# 3. 重新配置
copy env.network-template .env.local

# 4. 重新启动
supabase start
npm run dev
```

### 完全清理

```bash
# 停止并清理 Supabase
supabase stop
supabase db reset

# 重新启动
supabase start
```

## 参考文档

- [局域网访问开发服务器指南.md](./局域网访问开发服务器指南.md)
- [局域网访问本地数据库配置指南.md](./局域网访问本地数据库配置指南.md)

## 总结

✅ **配置完成后：**
- 电脑访问：`http://192.168.31.25:3000`
- iPad 访问：`http://192.168.31.25:3000`
- 共享同一个数据库
- 数据实时同步
- 随时随地测试！

---

最后更新：2025年10月11日

