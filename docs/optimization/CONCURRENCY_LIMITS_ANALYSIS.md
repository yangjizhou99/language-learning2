# 并发限制分析与优化方案

## 当前上限分析

### 1. 浏览器限制（主要瓶颈）

| 浏览器  | 默认并发连接数 | 可配置 |
| ------- | -------------- | ------ |
| Chrome  | 6个/域名       | 是     |
| Firefox | 6个/域名       | 是     |
| Safari  | 6个/域名       | 是     |
| Edge    | 6个/域名       | 是     |

**突破方法**：多域名方案

- 每个域名6个连接
- 6个域名 = 36个并发连接

### 2. 服务器限制

#### Next.js/Vercel限制

- **Vercel Pro**: 1000个并发请求
- **Vercel Hobby**: 100个并发请求
- **自托管**: 取决于服务器配置

#### 数据库限制

- **Supabase**: 500个并发连接（免费版）
- **Supabase Pro**: 1000个并发连接
- **自托管PostgreSQL**: 取决于配置

#### AI API限制

- **OpenRouter**: 1000个请求/分钟
- **DeepSeek**: 1000个请求/分钟
- **OpenAI**: 3000个请求/分钟

### 3. 网络限制

#### 客户端网络

- **带宽**: 影响请求速度
- **延迟**: 影响响应时间
- **连接数**: 操作系统限制

#### 服务器网络

- **带宽**: 影响处理能力
- **延迟**: 影响响应时间
- **连接池**: 服务器配置

## 优化方案对比

### 方案1：多域名（当前实现）

- **优点**: 简单、有效、成本低
- **缺点**: 需要配置DNS
- **上限**: 36个并发（6个域名）
- **实现难度**: ⭐⭐

### 方案2：WebSocket连接

- **优点**: 突破HTTP限制
- **缺点**: 实现复杂、需要长连接
- **上限**: 理论上无限制
- **实现难度**: ⭐⭐⭐⭐

### 方案3：Service Worker

- **优点**: 后台处理、不占用主线程
- **缺点**: 浏览器兼容性、实现复杂
- **上限**: 取决于浏览器
- **实现难度**: ⭐⭐⭐⭐

### 方案4：服务器端队列

- **优点**: 无浏览器限制
- **缺点**: 需要后端改造
- **上限**: 取决于服务器
- **实现难度**: ⭐⭐⭐

### 方案5：CDN + 多区域

- **优点**: 全球分布、高可用
- **缺点**: 成本高、配置复杂
- **上限**: 理论上无限制
- **实现难度**: ⭐⭐⭐⭐

## 推荐配置

### 当前配置（推荐）

```
域名数量: 6个
并发连接: 36个
配置难度: 简单
成本: 免费
```

### 高级配置

```
域名数量: 10个
并发连接: 60个
配置难度: 中等
成本: 免费
```

### 极限配置

```
域名数量: 20个
并发连接: 120个
配置难度: 复杂
成本: 免费
```

## 实际测试建议

### 1. 逐步测试

1. 先测试6个并发（1个域名）
2. 再测试12个并发（2个域名）
3. 最后测试36个并发（6个域名）

### 2. 监控指标

- **请求成功率**: 应该 > 95%
- **平均响应时间**: 应该 < 30秒
- **错误率**: 应该 < 5%
- **服务器负载**: 监控CPU和内存

### 3. 优化建议

- 根据实际性能调整并发数
- 监控AI API的使用限制
- 考虑添加重试机制
- 实现智能负载均衡

## 理论最大并发数

### 浏览器层面

- **单域名**: 6个连接
- **多域名**: 6 × 域名数量
- **理论最大**: 无限制（但实际受其他因素限制）

### 服务器层面

- **Vercel Hobby**: 100个并发
- **Vercel Pro**: 1000个并发
- **自托管**: 取决于硬件

### 数据库层面

- **Supabase免费**: 500个连接
- **Supabase Pro**: 1000个连接
- **自托管**: 取决于配置

### 实际建议上限

- **保守估计**: 30个并发
- **推荐配置**: 36个并发
- **极限测试**: 60个并发

## 总结

当前的多域名方案是最简单有效的优化方法，可以将并发数从6个提升到36个，提升6倍性能。如果需要更高并发，可以考虑：

1. 增加更多子域名
2. 优化服务器配置
3. 使用CDN加速
4. 实现服务器端队列

建议先测试36个并发，根据实际效果再决定是否需要进一步优化。
