# 删除未使用表执行指南

## 概述

本指南将安全地删除12个数据库表，以简化数据库结构并减少维护成本。

## 要删除的表

### Article题库相关（界面已删除）
1. `article_cloze` - 空表结构
2. `article_keys` - 空表结构  
3. `articles` - 空表结构
4. `article_drafts` - 文章草稿

### Cloze题型相关（有专门表）
5. `cloze_drafts` - 完形填空草稿
6. `cloze_items` - 完形填空题目

### RAG功能相关（功能已删除）
7. `glossary` - 词汇表
8. `phrases` - 短语表

### 其他未使用表
9. `registration_config` - 注册配置
10. `sessions` - 用户会话
11. `study_cards` - 学习卡片
12. `tts_assets` - TTS音频资源

## 执行步骤

### 1. 执行前验证

在删除表之前，请先运行验证脚本确保这些表确实没有被使用：

```bash
# 设置环境变量
export NEXT_PUBLIC_SUPABASE_URL="your_supabase_url"
export SUPABASE_SERVICE_ROLE_KEY="your_service_role_key"

# 运行验证脚本
node scripts/verify-unused-tables.js
```

如果验证脚本显示有代码引用，请先移除这些引用再继续。

### 2. 备份数据库（推荐）

在删除表之前，建议先备份数据库：

```bash
# 使用Supabase CLI备份
npx supabase db dump --data-only > backup_before_table_removal.sql

# 或者使用pg_dump
pg_dump "your_database_url" > backup_before_table_removal.sql
```

### 3. 执行删除迁移

```bash
# 推送迁移到Supabase
npx supabase db push

# 或者如果使用本地开发环境
npx supabase migration up
```

### 4. 验证删除结果

删除后，可以验证表是否已被成功删除：

```sql
-- 在Supabase SQL编辑器中执行
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN (
  'article_cloze', 'article_keys', 'articles', 
  'registration_config', 'sessions', 'study_cards', 'tts_assets'
);
```

如果查询结果为空，说明表已成功删除。

## 回滚方案

如果删除后发现问题，可以使用回滚迁移恢复表结构：

```bash
# 执行回滚迁移
npx supabase db push

# 或者手动执行回滚SQL
npx supabase db reset --linked
```

## 注意事项

1. **数据丢失**: 删除表会永久删除其中的所有数据，请确保这些表确实没有重要数据。

2. **依赖关系**: 虽然这些表没有在应用代码中被使用，但可能被其他表通过外键引用。迁移文件使用了 `CASCADE` 选项来处理这种情况。

3. **RLS策略**: 迁移文件会先删除相关的RLS策略，然后删除表。

4. **索引**: 迁移文件会先删除相关的索引，然后删除表。

## 文件说明

- `supabase/migrations/20250127000000_remove_unused_tables.sql` - 删除表的迁移文件
- `supabase/migrations/20250127000001_rollback_remove_unused_tables.sql` - 回滚迁移文件
- `scripts/verify-unused-tables.js` - 验证脚本
- `删除未使用表执行指南.md` - 本指南

## 预期结果

删除完成后：
- 数据库表数量从54个减少到42个
- 减少维护成本
- 简化数据库结构
- 不会影响应用功能（因为相关功能已删除或有专门表）

## 联系支持

如果在执行过程中遇到任何问题，请：
1. 检查Supabase控制台的错误日志
2. 运行验证脚本确认表的使用情况
3. 使用回滚迁移恢复表结构
