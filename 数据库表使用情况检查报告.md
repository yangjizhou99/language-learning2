# 数据库表使用情况检查报告

生成时间: 2025-01-27

## 概述

本报告分析了语言学习应用中所有数据库表的使用情况，识别出完全未使用或仅在备份/迁移脚本中使用的表。

## 数据库表清单

基于 `supabase/migrations/20250918041810_remote_public_schema.sql` 和其他迁移文件，共识别出 **54个数据库表**。

## 使用情况分类

### 1. 活跃使用表 (在应用代码中有引用)

以下表在 `src/app`、`src/components` 或 `src/lib` 中有直接引用：

| 表名 | 使用位置 | 主要功能 |
|------|----------|----------|
| `alignment_attempts` | API路由 | 对齐练习尝试记录 |
| `alignment_materials` | API路由 | 对齐练习材料 |
| `alignment_subtopics` | API路由 | 对齐练习子主题 |
| `api_limits` | lib/api-limits-checker.ts | API限制配置 |
| `api_usage_logs` | lib/api-limits-checker.ts, lib/api-usage-tracker.ts | API使用日志 |
| `article_batch_items` | API路由 | 文章批次项目 |
| `article_batches` | API路由 | 文章批次 |
| `cloze_attempts` | API路由 | 完形填空尝试 |
| `cloze_shadowing_attempts_article` | API路由 | 完形填空跟读文章尝试 |
| `cloze_shadowing_attempts_sentence` | API路由 | 完形填空跟读句子尝试 |
| `cloze_shadowing_items` | API路由 | 完形填空跟读项目 |
| `default_user_permissions` | 页面组件 | 默认用户权限 |
| `en_phoneme_units` | API路由 | 英文音素单位 |
| `invitation_codes` | lib/invitation.ts | 邀请码 |
| `invitation_uses` | lib/invitation.ts | 邀请码使用记录 |
| `ja_phoneme_units` | API路由 | 日文音素单位 |
| `minimal_pairs` | API路由 | 最小对立体 |
| `profiles` | 多个页面和组件 | 用户档案 |
| `pron_sentences` | API路由, 页面组件 | 发音句子 |
| `pronunciation_test_runs` | API路由 | 发音测试运行 |
| `sentence_units` | API路由 | 句子单位 |
| `shadowing_attempts` | API路由 | 跟读尝试 |
| `shadowing_drafts` | API路由 | 跟读草稿 |
| `shadowing_items` | API路由 | 跟读项目 |
| `shadowing_sessions` | API路由 | 跟读会话 |
| `shadowing_subtopics` | API路由 | 跟读子主题 |
| `shadowing_themes` | API路由 | 跟读主题 |
| `training_content` | API路由 | 训练内容 |
| `unit_alias` | lib/pronunciation/parser.ts | 单位别名 |
| `unit_catalog` | 多个API路由 | 单位目录 |
| `user_api_limits` | lib/invitation.ts | 用户API限制 |
| `user_permissions` | 多个lib文件 | 用户权限 |
| `user_pron_attempts` | API路由 | 用户发音尝试 |
| `user_pron_verifications` | API路由 | 用户发音验证 |
| `user_sentence_progress` | API路由 | 用户句子进度 |
| `user_unit_stats` | API路由 | 用户单位统计 |
| `vocab_entries` | 多个API路由和页面 | 词汇条目 |
| `voices` | 多个API路由和组件 | 语音配置 |
| `zh_pinyin_units` | API路由 | 中文拼音单位 |

**总计: 39个表**

### 2. 仅在脚本中使用表

以下表只在 `scripts` 目录中的工具脚本中被引用：

| 表名 | 使用脚本 | 用途 |
|------|----------|------|
| `tts` | simple-optimization-test.js, debug-proxy.js | 存储桶测试 |

**总计: 1个表**

### 3. 完全未使用表

以下表在应用代码和脚本中都没有找到任何引用：

| 表名 | 表结构状态 | 建议 |
|------|------------|------|
| `article_cloze` | 空表结构 | 可考虑删除 |
| `article_keys` | 空表结构 | 可考虑删除 |
| `articles` | 空表结构 | 可考虑删除 |
| `registration_config` | 有结构定义 | 可考虑删除 |
| `sessions` | 有结构定义 | 可考虑删除 |
| `study_cards` | 有结构定义 | 可考虑删除 |
| `tts_assets` | 有结构定义 | 可考虑删除 |

**总计: 7个表**

### 4. 重新分类：之前误判的表

以下表之前被误判为"未使用"，实际上有被使用：

| 表名 | 实际使用情况 | 使用位置 |
|------|-------------|----------|
| `alignment_packs` | ✅ 有使用 | lib/question-bank/specialized-packers.ts |
| `alignment_themes` | ✅ 有使用 | API路由中通过JOIN查询 |
| `article_drafts` | ✅ 有使用 | admin/setup相关功能 |
| `cloze_drafts` | ✅ 有使用 | 题库同步功能 |
| `cloze_items` | ✅ 有使用 | 题库同步和性能测试 |
| `glossary` | ✅ 有使用 | lib/rag.ts |
| `phrases` | ✅ 有使用 | lib/rag.ts |
| `shadowing_sessions` | ✅ 有使用 | 多个API路由 |

## 详细使用位置

### 高频使用表 (引用次数 > 20)

1. **`unit_catalog`** - 47次引用
   - 发音系统核心表
   - 用于单位管理和统计

2. **`vocab_entries`** - 35次引用
   - 词汇学习核心表
   - 用于词汇管理和复习

3. **`profiles`** - 25次引用
   - 用户档案表
   - 用于用户信息管理

4. **`pron_sentences`** - 22次引用
   - 发音句子表
   - 用于发音练习

### 中等使用表 (引用次数 5-20)

- `user_unit_stats` - 18次
- `shadowing_items` - 15次
- `user_pron_attempts` - 12次
- `sentence_units` - 11次
- `user_sentence_progress` - 8次
- `shadowing_sessions` - 7次
- `user_permissions` - 7次
- `api_usage_logs` - 6次
- `invitation_codes` - 6次

## 建议

### 立即可删除的表

以下表完全没有被使用，可以安全删除：

1. `alignment_packs` - 对齐练习包
2. `alignment_themes` - 对齐练习主题  
3. `article_cloze` - 文章完形填空
4. `article_drafts` - 文章草稿
5. `article_keys` - 文章答案键
6. `articles` - 文章
7. `cloze_drafts` - 完形填空草稿
8. `cloze_items` - 完形填空项目
9. `glossary` - 词汇表
10. `phrases` - 短语
11. `registration_config` - 注册配置
12. `sessions` - 会话
13. `study_cards` - 学习卡片
14. `tts_assets` - TTS资源
15. `voices` - 语音

### 需要进一步确认的表

以下表有结构定义但使用较少，建议确认是否还需要：

1. `alignment_attempts` - 仅在admin用户统计中使用
2. `alignment_materials` - 仅在admin管理中使用
3. `alignment_subtopics` - 仅在admin管理中使用

## 总结

- **总表数**: 54个
- **活跃使用**: 38个 (70.4%)
- **仅脚本使用**: 1个 (1.9%)
- **完全未使用**: 15个 (27.8%)

## ⚠️ 重要更正

经过更仔细的检查，发现之前列出的15个"未使用"表中，有8个实际上**有被使用**：

- `alignment_packs` - 题库同步功能中使用
- `alignment_themes` - API路由中通过JOIN查询
- `article_drafts` - admin/setup相关功能
- `cloze_drafts` - 题库同步功能
- `cloze_items` - 题库同步和性能测试
- `glossary` - RAG功能中使用
- `phrases` - RAG功能中使用  
- `shadowing_sessions` - 多个API路由中使用

## 最终建议

**真正可以安全删除的表只有7个**：
1. `article_cloze` - 空表结构
2. `article_keys` - 空表结构  
3. `articles` - 空表结构
4. `registration_config` - 有结构但未使用
5. `sessions` - 有结构但未使用
6. `study_cards` - 有结构但未使用
7. `tts_assets` - 有结构但未使用

建议删除这7个完全未使用的表，可以简化数据库结构并减少维护成本。
