# 题库筛选与导出系统使用指南

## 概述

本系统为您的语言学习应用提供了完整的题库筛选、打包和远程数据库同步功能。您可以在本地服务器上筛选现有的题库内容，创建导出包，然后同步到远程生产数据库。

## 功能特性

### 🎯 核心功能
- **多类型题库支持**：支持跟读练习、完形填空、对齐练习三种题型
- **智能筛选**：按语言、等级、类型、关键词进行筛选
- **批量选择**：支持全选、批量选择、清空选择
- **导出包管理**：创建、预览、下载导出包
- **远程同步**：安全同步到远程生产数据库

### 📊 筛选功能
- **语言筛选**：中文、英文、日文
- **等级筛选**：L1-L5 五个难度等级
- **类型筛选**：跟读练习、完形填空、对齐练习
- **关键词搜索**：支持标题和内容搜索

## 使用方法

### 1. 访问管理页面

访问 `/admin/question-bank/export` 页面，您将看到题库筛选与导出界面。

### 2. 配置远程数据库

在页面顶部的"远程数据库配置"区域填写：
- **数据库URL**：您的远程Supabase项目URL
- **服务密钥**：远程数据库的服务角色密钥
- **数据库名称**：用于标识的数据库名称

### 3. 筛选题库内容

使用筛选区域进行内容筛选：
1. **搜索关键词**：在标题或内容中搜索
2. **选择语言**：筛选特定语言的题目
3. **选择等级**：筛选特定难度等级
4. **选择类型**：筛选特定题型
5. **点击刷新数据**：重新加载数据

### 4. 选择要导出的题目

- **单个选择**：点击题目左侧的复选框
- **全选**：点击顶部的全选复选框
- **清空选择**：点击"清空选择"按钮

### 5. 创建导出包

1. 选择完题目后，点击"创建导出包"按钮
2. 填写导出包信息：
   - **包名称**：导出包的名称
   - **描述**：可选的描述信息
3. 点击"创建导出包"确认

### 6. 管理导出包

创建后的导出包会显示在页面底部的"导出包列表"中，您可以：

#### 预览导出包
- 查看题目统计信息
- 按类型、语言、等级分组显示
- 查看导出包状态

#### 下载JSON文件
- 点击"下载JSON"按钮
- 将导出包保存为本地JSON文件
- 文件名格式：`包名_日期.json`

#### 同步到远程数据库
- 确保已配置远程数据库连接信息
- 点击"同步远程"按钮
- 系统会自动将题目同步到远程数据库

## 技术实现

### 数据库表结构

系统支持同步以下表的数据：

#### shadowing_items（跟读练习）
```sql
- id: 题目ID
- lang: 语言 (zh/en/ja)
- level: 等级 (1-5)
- title: 标题
- text: 文本内容
- audio_url: 音频URL
- duration_ms: 音频时长
- tokens: 词数统计
- cefr: CEFR等级
- meta: 元数据
- created_at: 创建时间
- translations: 翻译内容
- theme_id: 主题ID
- subtopic_id: 子主题ID
```

#### cloze_items（完形填空）
```sql
- id: 题目ID
- lang: 语言
- level: 等级
- topic: 主题
- title: 标题
- passage: 文章内容
- blanks: 空白位置
- meta: 元数据
- created_at: 创建时间
```

#### alignment_packs（对齐练习）
```sql
- id: 包ID
- lang: 语言
- level: 等级
- topic: 主题
- title: 标题
- content: 内容
- meta: 元数据
- created_at: 创建时间
```

### API接口

#### 获取题库数据
- `GET /api/admin/shadowing/items` - 获取跟读练习题目
- `GET /api/admin/cloze/items` - 获取完形填空题目
- `GET /api/admin/alignment/packs` - 获取对齐练习包

#### 同步到远程数据库
- `POST /api/admin/question-bank/sync-remote` - 同步数据到远程数据库

### 安全特性

- **管理员权限验证**：所有操作需要管理员权限
- **数据验证**：同步前验证数据完整性
- **错误处理**：详细的错误信息和回滚机制
- **连接验证**：同步前验证远程数据库连接

## 使用场景

### 场景1：本地开发到生产部署
1. 在本地开发环境生成和测试题库
2. 使用筛选功能选择高质量题目
3. 创建导出包并同步到生产数据库

### 场景2：题库内容迁移
1. 从旧系统导出题库数据
2. 导入到本地数据库
3. 筛选和整理内容
4. 同步到新的生产环境

### 场景3：多环境数据同步
1. 在测试环境验证题库内容
2. 筛选通过测试的题目
3. 批量同步到生产环境

## 注意事项

### 数据安全
- 确保远程数据库连接信息的安全性
- 建议在同步前备份远程数据库
- 使用HTTPS连接确保数据传输安全

### 性能考虑
- 大量数据同步可能需要较长时间
- 建议分批同步大量数据
- 监控API使用量和数据库性能

### 错误处理
- 同步失败时会显示详细错误信息
- 部分成功时会显示成功和失败的统计
- 建议根据错误信息调整数据后重试

## 故障排除

### 常见问题

1. **远程数据库连接失败**
   - 检查URL和密钥是否正确
   - 确认远程数据库服务是否正常
   - 检查网络连接

2. **同步部分失败**
   - 查看错误信息确定失败原因
   - 检查数据格式是否符合要求
   - 确认远程数据库表结构是否匹配

3. **权限错误**
   - 确认当前用户具有管理员权限
   - 检查远程数据库的服务角色密钥权限

4. **数据格式错误**
   - 检查题目数据是否完整
   - 确认必填字段是否都有值
   - 验证数据类型是否正确

## 更新日志

### v1.0.0 (2025-01-20)
- 初始版本发布
- 支持三种题型的筛选和导出
- 实现远程数据库同步功能
- 提供完整的管理界面

## 技术支持

如有问题或建议，请联系开发团队或查看项目文档。

